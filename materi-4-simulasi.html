<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modul 4: The Final Boss (20 Rounds)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Plus+Jakarta+Sans:wght@400;600;800&family=Lora:ital,wght@0,600;1,500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #020617; 
            --panel: #0F172A;
            --border: #1E293B;
            --text-main: #E2E8F0;
            --text-muted: #94A3B8;
            --gold: #F59E0B;
            --gold-glow: rgba(245, 158, 11, 0.4);
            --red: #EF4444;
            --green: #10B981;
            --font-tech: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
        }

        /* ================= FX LAYERS ================= */
        .fx-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 90; opacity: 0; transition: opacity 0.1s;
        }
        #damageOverlay {
            background: radial-gradient(circle, transparent 50%, rgba(239, 68, 68, 0.6) 100%);
            box-shadow: inset 0 0 100px rgba(239, 68, 68, 0.8);
        }
        #healOverlay {
            background: radial-gradient(circle, transparent 50%, rgba(16, 185, 129, 0.4) 100%);
            box-shadow: inset 0 0 100px rgba(16, 185, 129, 0.6);
        }
        .trigger-damage { animation: flashRed 0.5s ease-out; }
        .trigger-heal { animation: flashGreen 0.5s ease-out; }

        @keyframes flashRed { 0% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0; transform: scale(1); } }
        @keyframes flashGreen { 0% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0; transform: scale(1); } }

        /* ================= INTRO ================= */
        .screen-intro {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%);
            z-index: 100; transition: opacity 0.5s;
        }
        .intro-title {
            font-size: 4rem; font-weight: 800; text-transform: uppercase; margin: 0;
            background: linear-gradient(to bottom, #FFF, #94A3B8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .start-btn {
            margin-top: 40px; background: var(--gold); color: black; border: none;
            padding: 20px 50px; font-size: 1.2rem; font-weight: 800; font-family: var(--font-tech);
            cursor: pointer; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: 0.2s; box-shadow: 0 0 30px var(--gold-glow);
        }
        .start-btn:hover { transform: scale(1.05); background: #fff; }

        /* ================= BATTLE HUD ================= */
        .screen-battle {
            display: none; 
            grid-template-rows: 80px 1fr 60px; 
            height: 100vh; 
            width: 100%;
            overflow: hidden;
            opacity: 0; 
            transition: opacity 1s;
        }

        /* TOP BAR */
        .hud-top {
            background: #020617; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
        }
        .boss-hp-container {
            width: 300px; height: 10px; background: #334155; border-radius: 5px; overflow: hidden; position: relative;
        }
        .boss-hp-bar {
            width: 100%; height: 100%; background: var(--gold); transition: width 0.5s; box-shadow: 0 0 10px var(--gold);
        }
        .timer { font-family: var(--font-tech); font-size: 1.5rem; font-weight: bold; color: #EF4444; }

        /* ================= ARENA LAYOUT (3 COLUMNS) ================= */
        .battle-arena {
            display: grid;
            /* 180px for Boss | Flexible Text | Fixed Quiz */
            grid-template-columns: 180px 1fr 0.8fr; 
            height: 100%;
            overflow: hidden;
        }
        /* ================= MOBILE FIXED (ABSOLUTE POSITIONING) ================= */
@media (max-width: 900px) {

    /* 1. MAIN LAYOUT */
    .battle-arena {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 60px); 
        overflow: hidden; 
    }

    /* 2. THE HEADER STRIP */
    .boss-sidebar {
        height: 120px; /* Increased slightly to fit his head */
        min-height: 120px;
        width: 100%;
        background: #0f172a; 
        border-bottom: 3px solid var(--gold);
        
        /* CRITICAL: Allows us to pin the boss inside */
        position: relative; 
        display: block; /* Stop using Flexbox for the container */
        overflow: hidden; /* Cut off his legs, keep the body */
    }

    /* 3. THE BOSS (PINNED TO BOTTOM) */
    .boss-frame {
        position: absolute;
        bottom: 0; /* Sit on the floor of the header */
        left: 50%; /* Center horizontally */
        transform: translateX(-50%); /* Center alignment correction */
        
        width: 160px; /* Give him a fixed width container */
        height: 100%; 
        z-index: 10; /* Ensure he is above the background */
        
        /* Remove old flex properties that might conflict */
        display: block; 
        margin: 0;
    }

    .boss-scaler {
        /* Force him to be anchored to the bottom center */
        transform-origin: bottom center !important; 
        transform: scale(0.38) !important; /* Scale him down */
        
        /* Positioning inside the frame */
        position: absolute;
        bottom: -15px; /* Push him down slightly so we see chest-up */
        left: 0;
        right: 0;
        margin: 0 auto;
    }

    /* 4. CHAT BUBBLE (TOP RIGHT) */
    .boss-bubble {
        left: auto !important;
        right: 10px !important; /* Stick to right edge */
        top: 10px !important;
        width: 140px !important;
        transform-origin: top right;
        z-index: 20;
    }
    .boss-bubble::after {
        left: auto; right: 20px; /* Tail points right */
        bottom: -10px; top: auto;
        border-width: 10px 10px 0; /* Triangle pointing down */
        border-color: white transparent transparent transparent;
    }

    /* 5. TEXT PANEL (SCROLLABLE) */
    .text-panel {
        flex: 1; 
        overflow-y: auto; 
        padding: 20px;
        background: var(--bg);
        font-size: 1rem;
        border-bottom: 1px solid var(--border);
    }

    /* 6. CONTROL PANEL (BOTTOM) */
    .control-panel {
        height: 35%;
        min-height: 220px;
        overflow-y: auto;
        padding: 10px;
        background: #1e293b;
    }

    /* HIDE the "PENGAWAS" label */
    .boss-sidebar div[style*="font-size:0.7rem"] { display: none; }
}

        /* ================= BOSS SIDEBAR ================= */
        .boss-sidebar {
            background: #020617; /* Very Dark */
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding-top: 100px;
            align-items: center;
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 20px;
            box-shadow: inset -10px 0 20px rgba(0,0,0,0.5); /* Shadow for depth */
        }

        /* ================= BOSS SPRITE (SIDEBAR MODE) ================= */
        .boss-frame {
            width: 100%;
            height: 300px; /* Tall enough for him */
            display: flex; 
            justify-content: center; 
            align-items: center;
            overflow: visible; 
            position: relative;
        }

        .boss-scaler {
            /* 1. MATH: 619px / 4 = 154.75px */
            width: 154.75px; 
            height: 337px;
            
            /* 2. SCALE: 0.6 fits perfectly in the 180px sidebar */
            transform: scale(1.0); 
            transform-origin: center center;
        }
        
        #bossEntity {
            width: 154.75px; 
            height: 337px;
            background-image: url("image/boss_idle.png"); 
            background-size: 619px 337px; 
            background-repeat: no-repeat;
            animation: play-sprite 1s steps(4) infinite;
            image-rendering: pixelated; 
        }

        /* --- STATES (Same as before) --- */
        @keyframes play-sprite {
            from { background-position: 0px 0px; }
            to { background-position: -619px 0px; } 
        }

        #bossEntity.state-damaged {
            background-image: url("image/boss_shock.png") !important;
            animation: play-sprite 0.5s steps(4) infinite;
            filter: sepia(100%) hue-rotate(-50deg) saturate(600%) brightness(0.8);
        }

        #bossEntity.state-attack {
            background-image: url("image/boss_angry.png") !important;
            animation: play-sprite 0.8s steps(4) infinite;
            filter: brightness(1.5) contrast(1.2);
        }

        /* TEXT PANEL */
        .text-panel {
            padding: 40px; overflow-y: auto; border-right: 1px solid var(--border);
            background: #0B101E; position: relative; transition: opacity 0.3s;
        }
        .passage { font-family: 'Lora', serif; font-size: 1.15rem; line-height: 1.8; color: #CBD5E1; max-width: 700px; margin: 0 auto; }
        .passage h3 { color: var(--gold); border-bottom: 1px solid #334155; padding-bottom: 10px; margin-top: 0; }

        /* TEXT FORMATS */
        .academic-text { font-family: 'Lora', serif; color: #CBD5E1; }
        .transcript-box { font-family: 'Plus Jakarta Sans', sans-serif; display: flex; flex-direction: column; gap: 15px; }
        .speech-bubble { background: #1E293B; padding: 15px; border-radius: 0 12px 12px 12px; border-left: 3px solid var(--gold); }
        .host { border-left-color: #34D399; }
        .speaker { display: block; font-size: 0.75rem; font-weight: 800; color: var(--gold); margin-bottom: 5px; }
        .host .speaker { color: #34D399; }

        .news-wrapper { background: #E2E8F0; color: #0F172A; padding: 30px; border-radius: 4px; }
        .news-headline { font-family: 'Times New Roman', serif; font-weight: 900; font-size: 2rem; line-height: 1; margin: 0 0 10px 0; }
        .news-meta { font-size: 0.8rem; font-weight: bold; color: #475569; border-bottom: 2px solid #0F172A; margin-bottom: 20px; padding-bottom: 10px; }
        .news-body { font-family: 'Georgia', serif; font-size: 1.1rem; line-height: 1.6; text-align: justify; }
        .news-wrapper .core { background: rgba(245, 158, 11, 0.3); color: black; }

        .log-wrapper { font-family: 'JetBrains Mono', monospace; color: #34D399; }
        .log-header { border-bottom: 1px dashed #34D399; padding-bottom: 10px; margin-bottom: 20px; opacity: 0.7; font-size: 0.8rem; }
        .log-entry::before { content: "> "; color: var(--gold); }

        /* TOOLS CSS */
        .mode-suffix .junk { opacity: 0.2; text-decoration: line-through; text-decoration-color: var(--red); transition: 0.3s; }
        .mode-xray .core { color: var(--gold); font-weight: 800; background: rgba(245, 158, 11, 0.15); padding: 0 4px; border-radius: 4px; transition: 0.3s; }
        .mode-logic .connector { border: 1px solid var(--green); color: var(--green); padding: 2px 6px; border-radius: 4px; font-weight: 800; background: rgba(16, 185, 129, 0.1); transition: 0.3s; }

        /* QUIZ PANEL */
        .control-panel { justify-content: flex-start !important; overflow-y: auto !important; padding: 20px 20px 20px 20px; background: #0F172A; display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; z-index: 1; }
        .q-card { background: #1E293B; border: 1px solid #334155; padding: 25px; border-radius: 12px; animation: slideIn 0.4s ease; margin-bottom: 0px; flex-shrink: 0;}
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .opt-btn {
            display: block; width: 100%; padding: 15px; margin-bottom: 10px;
            background: #0F172A; border: 1px solid #334155; color: #CBD5E1; text-align: left;
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .opt-btn:hover { border-color: var(--gold); color: white; background: #182030; }
        .opt-correct { background: #064E3B !important; border-color: #10B981 !important; color: white !important; }
        .opt-wrong { background: #450a0a !important; border-color: #EF4444 !important; opacity: 0.5; }

        /* HUD BOTTOM */
        .hud-bottom { 
            background: #020617; 
            border-top: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 20px;
            
        }
        .tool-btn {
            background: transparent; border: 1px solid #334155; color: #64748B;
            padding: 6px 12px; border-radius: 50px; font-family: var(--font-tech); font-size: 0.75rem;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .tool-btn:hover { border-color: var(--text-main); color: white; }
        .tool-active { border-color: var(--green); color: var(--green); background: rgba(16, 185, 129, 0.1); box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }

        /* MODALS */
        .feedback-modal {
            position: absolute; bottom: 100px; right: 30px; width: 350px;
            background: rgba(0,0,0,0.9); border: 1px solid var(--border); border-left: 4px solid var(--gold);
            padding: 20px; border-radius: 8px; color: white; display: none; backdrop-filter: blur(5px); z-index: 50;
        }
        .screen-win {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; justify-content: center; align-items: center;
        }
        .shake-screen { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(0,0); } 20% { transform: translate(-10px, 0); } 40% { transform: translate(10px, 0); } 100% { transform: translate(0,0); } }

        /* 1. BOSS CRITICAL STATE (HP < 30%) */
        #bossEntity.boss-critical {
            /* REPLACE 'boss_tantrum.png' WITH YOUR ACTUAL FILENAME */
            background-image: url("image/boss_tantrum.png") !important; 
            
            /* Make the animation FASTER (0.5s) to show panic/rage */
            animation: play-sprite 0.5s steps(4) infinite !important;
            
            /* Optional: Add a red shake effect on top of the sprite */
            animation-name: play-sprite, shake-constant !important;
            
            /* Remove the old color filters so we see your actual pixel art colors */
            filter: none !important; 
        }

        /* ================= COMBO & ENDINGS ================= */
        .combo-active { opacity: 1 !important; text-shadow: 0 0 10px var(--green); font-weight: 800; transform: scale(1.1); }
        
        /* Screen for Failing (Boss Alive) */
        .screen-fail {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50, 0, 0, 0.95); z-index: 200; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .fail-title { font-size: 4rem; color: var(--red); margin: 0; text-transform: uppercase; letter-spacing: 5px; }
        .fail-desc { color: #FECACA; font-size: 1.2rem; max-width: 600px; text-align: center; margin-top: 20px; line-height: 1.6; }
    
        /* ================= FAIL SCREEN ================= */
        .screen-fail {
            display: none; /* Hidden by default */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 0, 0, 0.98); /* Dark Red Background */
            z-index: 200; 
            flex-direction: column; justify-content: center; align-items: center;
        }
        
        .fail-title { 
            font-size: 4rem; font-weight: 800; color: var(--red); 
            margin: 0; text-transform: uppercase; letter-spacing: 5px; 
            text-shadow: 0 0 20px var(--red);
        }
        
        .fail-desc { 
            color: #FECACA; font-size: 1.5rem; max-width: 600px; 
            text-align: center; margin-top: 20px; line-height: 1.6; 
        }

        /* ================= RPG FEEDBACK EFFECTS ================= */
        
        /* 1. FLOATING DAMAGE NUMBERS */
        .damage-number {
            position: absolute;
            color: #FFD700; /* Gold */
            font-family: 'Impact', sans-serif;
            font-size: 2rem;
            font-weight: bold;
            pointer-events: none;
            z-index: 100;
            text-shadow: 2px 2px 0px #000;
            animation: floatUp 1s ease-out forwards;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-30px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-60px) scale(1); opacity: 0; }
        }

        /* 2. BOSS SPEECH BUBBLE */
        .boss-bubble {
            position: absolute;
            top: 10px; /* Near his head */
            left: 50%; /* To the right of the sidebar */
            transform: translateX(-50%) scale(0);
            background: white;
            color: black;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: var(--font-tech);
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            width: 90%;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        /* The little triangle pointing to him */
        .boss-bubble::after {
            content: "";
            position: absolute; bottom: -10px; left: 50%;
            transform: translateX(-50%);
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
        
        .bubble-show { 
            transform: translateX(-50%) scale(1) !important
         }
        
        @keyframes popIn { from{transform: scale(0);} to{transform: scale(1);} }

        /* ================= MOBILE RESPONSIVENESS (PHONES) ================= */
        @media (max-width: 900px) {

        /* 1. CHANGE GRID TO VERTICAL STACK */
        .battle-arena {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px); /* Fill screen minus Top HUD */
            overflow: hidden; /* Stop the whole page from scrolling */
            }

        /* 2. SHRINK BOSS TO A "MINI-HEADER" */
        .boss-sidebar {
            height: 90px; /* Fixed small height */
            min-height: 90px;
            width: 100%;
            flex-direction: row; /* Layout items horizontally */
            padding: 0 10px;
            border-right: none;
            border-bottom: 2px solid var(--gold);
            background: #020617;
            overflow: hidden;
            }

        /* 3. MAKE BOSS TINY */
        .boss-frame {
            width: 80px; /* Constrain width */
            height: 100%;
            margin: 0;
            }
    
        .boss-scaler {
            /* Shrink him drastically for mobile */
            transform: scale(0.35) !important; 
            transform-origin: bottom left; /* Anchor him to the bottom-left corner */
            margin-left: 10px;
            }

        /* Hide the "PENGAWAS" label on mobile to save space */
        .boss-sidebar div[style*="font-size:0.7rem"] {
            display: none;
            }
    
        /* Move Chat Bubble to right side on mobile */
        .boss-bubble {
            left: 120px !important;
            top: 20px !important;
            width: 150px !important;
            transform: scale(0);
            transform-origin: left center;
            }
        .boss-bubble::after {
            left: -10px; bottom: auto; top: 10px; /* Point left towards boss */
            border-width: 10px 10px 10px 0;
            border-color: transparent white transparent transparent;
            }

        /* 4. TEXT PANEL (SCROLLABLE TOP HALF) */
        .text-panel {
            flex: 1; /* Take 50% of remaining space */
            height: auto;
            overflow-y: auto; /* Enable scrolling inside this box */
            border-right: none;
            border-bottom: 1px solid var(--border);
            padding: 15px;
            font-size: 0.95rem; /* Slightly smaller text for reading */
            }

        /* 5. QUIZ PANEL (SCROLLABLE BOTTOM HALF) */
        .control-panel {
            flex: 1; /* Take other 50% */
            height: auto;
            overflow-y: auto; /* Enable scrolling for answers */
            padding: 10px;
            background: #0f172a;
            }

        /* Fix Buttons for Touch Screens */
        .opt-btn {
            padding: 12px 10px;
            min-height: 50px; /* Easier to tap */
            font-size: 0.9rem;
            }
    
        .q-card {
            margin-bottom: 50px; /* Extra space at bottom for scrolling */
            }
        }/* ================= BOSS SKILLS FX ================= */

/* SKILL 1: INK SPLATTER */
    .ink-blob {
    position: absolute;
    background: #000;
    border-radius: 50%;
    filter: blur(2px);
    z-index: 50;
    cursor: pointer;
    /* Look like irregular ink */
    box-shadow: 0 0 10px rgba(0,0,0,0.8);
    animation: splat 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
/* Add a shine to make it look wet */
.ink-blob::after {
    content: '';
    position: absolute;
    top: 20%; left: 20%;
    width: 20%; height: 20%;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
}
@keyframes splat { from { transform: scale(0); } to { transform: scale(1); } }
.ink-cleaned { animation: fadeOut 0.3s forwards; }
@keyframes fadeOut { to { opacity: 0; transform: scale(1.5); } }

/* SKILL 2: SILENCE (LOCKED BUTTONS) */
.opt-locked {
    background: #334155 !important;
    color: #64748B !important;
    border-color: #475569 !important;
    cursor: not-allowed !important;
    position: relative;
    overflow: hidden;
}
/* Chains icon overlay */
.opt-locked::after {
    content: "üîí LOCKED";
    position: absolute;
    top: 50%; right: 20px;
    transform: translateY(-50%);
    font-family: var(--font-tech);
    color: #94A3B8;
    font-size: 0.8rem;
    letter-spacing: 2px;
}

/* SKILL 3: GLITCH TEXT */
.text-glitched {
    animation: glitch-anim 0.3s infinite;
    color: var(--red) !important;
    text-shadow: 2px 0 blue, -2px 0 red;
}
@keyframes glitch-anim {
    0% { transform: translate(0) }
    20% { transform: translate(-2px, 2px) }
    40% { transform: translate(-2px, -2px) }
    60% { transform: translate(2px, 2px) }
    80% { transform: translate(2px, -2px) }
    100% { transform: translate(0) }
}

.cursed-word {
    color: #C084FC;
    font-family: 'Times New Roman', serif;
    font-weight: bold;
    border-bottom: 1px dashed #C084FC;
    cursor: help;
    
    /* CRITICAL FIXES */
    user-select: none;           /* Allow clicking, not highlighting */
    -webkit-user-select: none;
    pointer-events: auto !important; /* Force it to accept clicks */
    position: relative;          /* Lift it up */
    z-index: 100;                /* Ensure it's above overlays */
    display: inline-block;
}

@keyframes pulseText {
    0% { text-shadow: 0 0 2px #C084FC; }
    50% { text-shadow: 0 0 8px #C084FC; }
    100% { text-shadow: 0 0 2px #C084FC; }
}

/* PANIC OVERLAY (When peeking at words) */
.panic-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: radial-gradient(circle, transparent 20%, rgba(220, 38, 38, 0.6) 90%);
    z-index: 50;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    mix-blend-mode: multiply;
}
.panic-active { opacity: 1; animation: pulseRed 0.5s infinite; }

@keyframes pulseRed {
    0% { background: radial-gradient(circle, transparent 20%, rgba(220, 38, 38, 0.6) 90%); }
    50% { background: radial-gradient(circle, transparent 15%, rgba(220, 38, 38, 0.8) 90%); }
    100% { background: radial-gradient(circle, transparent 20%, rgba(220, 38, 38, 0.6) 90%); }
}   

    /* HERO UI */
    .focus-pip {
        width: 30px; height: 10px;
        background: #1e293b; 
        border: 1px solid #475569;
        transform: skewX(-20deg);
        transition: 0.3s;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
    }
    .focus-pip.active {
        background: #0EA5E9; /* Cyan Glow */
        border-color: #7DD3FC;
        box-shadow: 0 0 10px #0EA5E9, inset 0 0 5px white;
    }

    .skill-btn {
        flex: 1;
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 4px;
        color: #94a3b8;
        cursor: not-allowed;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        transition: 0.2s;
    }
    .skill-icon { font-size: 1.2rem; filter: grayscale(1); }
    
    /* UNLOCKED STATE */
    .skill-btn.ready {
        background: linear-gradient(to bottom, #1e293b, #0f172a);
        border-color: #38BDF8;
        color: white;
        cursor: pointer;
        box-shadow: 0 2px 0 #0f172a;
    }
    .skill-btn.ready:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(56, 189, 248, 0.3); }
    .skill-btn.ready:active { transform: translateY(0); }
    .skill-btn.ready .skill-icon { filter: grayscale(0); }

    /* Button Colors */
    .skill-btn.ready:nth-child(1) { border-bottom: 2px solid #22c55e; } /* Green */
    .skill-btn.ready:nth-child(2) { border-bottom: 2px solid #eab308; } /* Gold */
    .skill-btn.ready:nth-child(3) { border-bottom: 2px solid #f43f5e; } /* Red */

    /* KEYWORD EXTRACTOR STYLES */
    .word-dimmed {
        opacity: 0.2; /* Fade out fluff words */
        font-weight: normal;
    }
    .word-highlight {
        color: #fff;
        font-weight: bold;
        text-shadow: 0 0 5px #38BDF8; /* Neon Blue Glow */
    }

    /* SNIPER MODE STYLES */
    body.sniper-active .opt-btn {
        cursor: crosshair !important; /* Turn cursor to crosshair */
    }
    body.sniper-active .opt-btn:hover {
        background: #ef4444 !important; /* Turn red on hover */
        color: white;
        border-color: red;
    }
    /* LOGIC CHAIN MODE */
    .logic-mode .word-dimmed {
        opacity: 0.1; /* Almost invisible */
        font-size: 0.9em;
    }
    
    .logic-subject {
        color: #38BDF8; /* Cyan */
        font-weight: bold;
        border-bottom: 2px solid #38BDF8;
    }

    .logic-verb {
        color: #FACC15; /* Yellow */
        font-weight: bold;
        margin: 0 5px;
    }

    .logic-arrow {
        display: inline-block;
        color: #FACC15;
        font-weight: bold;
        margin-right: 5px;
        animation: pulseArrow 1s infinite;
    }

    .logic-connector {
        background: #DC2626; /* Red Background */
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.8rem;
        margin-right: 5px;
        box-shadow: 0 0 10px #DC2626;
    }

    @keyframes pulseArrow {
        0% { transform: translateX(0); opacity: 0.5; }
        50% { transform: translateX(3px); opacity: 1; }
        100% { transform: translateX(0); opacity: 0.5; }
    }

    /* LOGIC DIAGRAM STYLES */
    .chain-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 20px;
        height: 100%;
        justify-content: center;
        animation: fadeIn 0.5s ease;
    }

    .chain-node {
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid #334155;
        color: #94a3b8;
        padding: 10px 15px;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        text-align: center;
        width: 80%;
        position: relative;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    /* Important Concepts (Blue) */
    .chain-node.core {
        border-color: #38BDF8;
        color: #38BDF8;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(56, 189, 248, 0.2);
    }

    /* The Final Conclusion (Red/Warning) */
    .chain-node.result {
        border-color: #F43F5E;
        color: #F43F5E;
        font-weight: bold;
        border-width: 2px;
    }

    /* The Arrow */
    .chain-arrow {
        color: #FACC15; /* Yellow */
        font-size: 1.2rem;
        font-weight: bold;
        text-shadow: 0 0 5px #FACC15;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ================= COLOR OVERRIDES ================= */

/* 1. THE READING PASSAGE TEXT */
/* Affects all types of text: Academic, News, Chat Logs, etc. */
.academic-text, 
.news-body, 
.log-body, 
.transcript-box, 
.passage {
    color: #F8FAFC !important; /* Bright White (Slate 50) */
    text-shadow: 0 0 1px rgba(0,0,0,0.5); /* Slight shadow for readability */
    font-weight: 400; /* Normal weight */
}

/* 2. THE QUESTION SENTENCE */
.q-text {
    color: #ffffff !important; /* Neon Cyan (Sky 400) */
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 15px;
    text-shadow: 0 0 10px rgba(56, 189, 248, 0.3); /* Soft Glow */
    line-height: 1.5;
}

/* 3. OPTIONAL: The "Question 1/20" Label */
.q-card div[style*="font-size:0.8rem"] {
    color: #FACC15 !important; /* Yellow/Gold */
    font-weight: 800;
    letter-spacing: 1px;
}
/* ================= THEME TITLE COLOR ================= */
.passage h3 {
    /* Change this HEX code to whatever color you want */
    color: #FACC15 !important; /* Current: Bright Gold */
    
    /* Optional: Make it glow */
    text-shadow: 0 0 10px rgba(250, 204, 21, 0.4); 
    
    /* Optional: Add a bottom border line */
    border-bottom: 2px solid #334155; 
    
    /* Layout spacing */
    padding-bottom: 10px;
    margin-top: 0;
    font-weight: 800; /* Extra Bold */
    letter-spacing: 1px;
}
/* ================= FIXED THEME TITLE COLOR ================= */
#textPanel h3 {
    /* Change this to a bright color (currently Gold) */
    color: #5ac2a9 !important; 
    font-family: 'Trebuchet MS', sans-serif;
    
    /* Optional: Add a text shadow to make it pop against dark blue */
    text-shadow: 0 0 10px rgba(0,0,0,0.8);

    /* Resetting margins to ensure it sits correctly */
    margin-top: 0;
    padding-bottom: 15px;
    border-bottom: 2px solid #334155;
}

    /* ================= SCROLLABLE QUIZ FIX ================= */

/* 1. Target the specific container holding the question card */
#quiz-container {
    height: 100%;       /* Fill the available grid space */
    overflow-y: auto;   /* Enable vertical scrolling */
    
    /* CRITICAL: Add padding at the bottom so Option E isn't cut off */
    padding-bottom: 60px !important; 
    
    /* Make scrollbar look nice */
    scrollbar-width: thin;
    scrollbar-color: var(--gold) #0F172A;
}

/* 2. Custom Scrollbar for Chrome/Edge */
#quiz-container::-webkit-scrollbar {
    width: 8px;
}
#quiz-container::-webkit-scrollbar-track {
    background: #0F172A;
}
#quiz-container::-webkit-scrollbar-thumb {
    background: #334155;
    border-radius: 4px;
}
#quiz-container::-webkit-scrollbar-thumb:hover {
    background: var(--gold);
}

/* 3. Mobile Specific Adjustment */
@media (max-width: 900px) {
    .control-panel {
        /* On mobile, the control panel holds the quiz */
        overflow-y: auto !important;
        padding-bottom: 80px !important; /* Extra space for touch scrolling */
    }
}
    /* ================= FIX FOR SHIP OF THESEUS TEXT ================= */
.news-wrapper, 
.news-body, 
.news-headline,
.news-meta {
    text-shadow: 0 0 1px rgba(0,0,0,0.8);
    background-color: #E2E8F0 !important;
    color: #0F172A !important; 
}
/* ================= SMART TOOL INTERACTIONS ================= */

/* 1. ADJECTIVE REMOVER (Default Behavior) */
/* When active, cross out ALL adjectives */
.mode-adj .adj-word {
    text-decoration: line-through; 
    color: #94A3B8; 
    opacity: 0.5;   
    transition: all 0.3s ease;
}

/* 2. X-RAY SCANNER (Default Behavior) */
/* When active, highlight important words */
.mode-xray .core {
    color: #fa8209 !important; /* Bright Green */
    font-weight: bold;
    text-shadow: 0 0 5px rgba(241, 44, 26, 0.5);
    opacity: 1 !important; /* Force visibility */
}

.mode-xray .junk {
    color: #F87171 !important; /* Red */
    text-decoration: underline;
    text-decoration-style: wavy;
    opacity: 1 !important; /* Force visibility */
}

/* ================= THE INTERACTION FIX ================= */
/* RULE: If BOTH tools are ON, "Protect" the Core/Junk words */

/* If X-Ray is ON, do NOT cross out .core words */
.mode-adj.mode-xray .adj-word.core {
    text-decoration: none !important; /* Remove strikethrough */
    opacity: 1 !important;            /* Make it fully visible */
}

/* If X-Ray is ON, do NOT cross out .junk words */
/* (We keep the wavy underline from X-Ray, but remove the strikethrough) */
.mode-adj.mode-xray .adj-word.junk {
    text-decoration: underline !important; 
    text-decoration-style: wavy !important;
    opacity: 1 !important;
}

    /* TRANSITION SCREEN */
.screen-transition {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 999;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    text-align: center;
    backdrop-filter: blur(5px);
}

.trans-content {
    border: 2px solid var(--neon-blue);
    padding: 40px;
    border-radius: 10px;
    box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
    background: #0f172a;
    max-width: 500px;
    width: 90%;
    animation: slideUp 0.5s ease-out;
}

#transTitle {
    color: var(--neon-green);
    font-size: 2.5rem;
    margin-bottom: 10px;
    text-shadow: 0 0 10px var(--neon-green);
}

#transDesc {
    color: #94a3b8;
    font-size: 1.1rem;
    margin-bottom: 30px;
}

.trans-stats {
    margin-bottom: 30px;
    padding: 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
}

.stat-val {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--gold);
    margin-top: 5px;
}

@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
    </style>
</head>
<body>

<div class="panic-overlay" id="panicOverlay"></div>
<div class="fx-overlay" id="damageOverlay"></div>
<div class="fx-overlay" id="healOverlay"></div>

<div class="screen-intro" id="introScreen">
    <div style="font-family: var(--font-tech); color: var(--gold); border: 1px solid var(--gold); padding: 5px 15px; border-radius: 4px; letter-spacing: 2px;">FINAL BOSS // 20 ROUNDS</div>
    <h1 class="intro-title">THE GAUNTLET</h1>
    <p style="color:#64748B; margin-top:10px;">4 Phases: Astro, Bio, Econ, AI</p>
    <button class="start-btn" onclick="startBattle()">START RAID</button>
</div>

<div class="screen-battle" id="battleScreen">
    
    <div class="hud-top">
        <div style="display:flex; flex-direction:column; flex:1; margin-right:20px;">
            
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div style="display:flex; gap:15px; align-items:center;">
                    <span style="font-family: var(--font-tech); font-size: 0.7rem; color: var(--gold);">BOSS INTEGRITY</span>
                    <span id="comboDisplay" style="font-family: var(--font-tech); font-size: 0.7rem; color: var(--green); opacity:0; transition:0.3s;">
                        CHAIN x1
                    </span>
                </div>
                <span style="font-family: var(--font-tech); font-size: 0.7rem; color: #818CF8;">
                    ABILITY CHARGE: <span id="manaText" style="font-weight:bold;">0%</span>
                </span>
            </div>

            <div style="display:flex; gap:10px; height:10px; width:100%;">
                
                <div class="boss-hp-container" style="flex:3; width:auto;">
                    <div class="boss-hp-bar" id="bossHP"></div>
                </div>

                <div style="flex:1; background:#1e293b; border-radius:5px; overflow:hidden; border:1px solid #334155; position:relative;">
                    <div id="bossManaBar" style="width:0%; height:100%; background:#818CF8; transition:width 0.2s; box-shadow:0 0 10px #818CF8;"></div>
                </div>
            
            </div>
        </div>

        <div class="timer" id="timer">20:00</div>
    </div>

    <div class="battle-arena">
        
        <div class="boss-sidebar" style="position:relative;"> <div id="bossBubble" class="boss-bubble">
            Jangan Mencontek!
        </div>
            <div class="boss-frame">
                <div class="boss-scaler">
                    <div id="bossEntity"></div>
                </div>
            </div>
            <div style="text-align:center; color:var(--text-muted); font-size:0.7rem; margin-top:10px; font-family:var(--font-tech);">
                PENGAWAS<br>AREA 04
            </div>
        </div>

        <div class="text-panel" id="textPanel">
            </div>

        <div class="control-panel">
            
            <div class="hero-interface" style="margin-bottom: 15px; padding: 10px; background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span style="font-family:var(--font-tech); font-size:0.7rem; color:#38BDF8;">NEURAL CHARGE</span>
                    <div class="focus-meter" style="display:flex; gap:5px;">
                        <div id="focus1" class="focus-pip"></div>
                        <div id="focus2" class="focus-pip"></div>
                        <div id="focus3" class="focus-pip"></div>
                        <div id="focus4" class="focus-pip"></div>
                        <div id="focus5" class="focus-pip"></div>
                    </div>
                </div>
                <div style="display:flex; gap:10px; height: 40px;">
                    <button id="skillBtn1" class="skill-btn disabled" onclick="castDoubleSlash()" title="Remove 2 Wrong Answers (Cost: 2)">
                        <span class="skill-icon">‚öîÔ∏è</span> <span class="skill-cost">II</span>
                    </button>
                    <button id="skillBtn2" class="skill-btn disabled" onclick="castKeywordExtractor()" title="FKeyword Extractor: Highlight Key Info (Cost: 3)">
                        <span class="skill-icon">üß¨</span> <span class="skill-cost">III</span>
                    </button>
                    <button id="skillBtn3" class="skill-btn disabled" onclick="castPrecisionStrike()" title="Precision Strike: Eliminate Wrong Anwers Manually (Cost: 4)">
                        <span class="skill-icon">üéØ</span> <span class="skill-cost">IV</span>
                    </button>
                </div>
            </div>

            <div id="quiz-container">
            </div>

            <div class="feedback-modal" id="fbModal"></div>
        </div>
    </div>

    <div class="hud-bottom">
        <button class="tool-btn" onclick="toggleTool(this, 'mode-suffix')"><span>‚úÇÔ∏è</span> SUFFIX CUTTER</button>
        <button class="tool-btn" onclick="toggleTool(this, 'mode-xray')"><span>üî¶</span> X-RAY SCANNER</button>
        <button class="tool-btn" onclick="toggleTool(this, 'mode-logic')"><span>üö¶</span> LOGIC VIEW</button>
    </div>

</div>

<div id="transitionScreen" class="screen-transition" style="display: none;">
    <div class="trans-content">
        <h1 id="transTitle">ROUND CLEARED!</h1>
        <p id="transDesc">Difficulty Increasing...</p>
        
        <div class="trans-stats">
            <div class="stat-box">
                <span class="stat-label">NEXT LEVEL</span>
                <span id="nextLevelName" class="stat-val">ADVANCED (C1)</span>
            </div>
        </div>

        <button class="start-btn" onclick="continueToNextRound()">INITIATE NEXT PHASE</button>
    </div>
</div>

<div class="screen-win" id="winScreen">
    <h1 style="font-size:4rem; color:var(--gold); margin:0;">VICTORY</h1>
    <p style="color:#CBD5E1; font-size:1.5rem;">YOU SURVIVED 20 ROUNDS</p>
    <a href="index.html" class="start-btn" style="text-decoration:none; display:inline-block; margin-top:30px;">RETURN TO LOBBY</a>
</div>

<div class="screen-fail" id="failScreen">
    <h1 class="fail-title">MISSION FAILED</h1>
    <p class="fail-desc">
        Target remains active. Logic sync failed.<br>
        <span style="font-size:1rem; opacity:0.8;">You ran out of questions before defeating the boss.</span>
    </p>
    <button class="start-btn" style="background:var(--red); color:white; border:1px solid white;" onclick="location.reload()">RETRY SIMULATION</button>
</div>

<script>
    // THE CHEAT FUNCTION
    function devSkip() {
        // 1. Check if there are more questions in this round
        if (currentQIndex + 1 < questions.length) {
            currentQIndex++;
            loadQuestion(currentQIndex);
            console.log("Skipped to Question: " + (currentQIndex + 1));
        } 
        // 2. If round is finished, load the next round
        else {
            console.log("Round Complete. Loading Next Round...");
            loadRound(currentRoundIndex + 1);
        }
    }
    // =========================================================================
    // SECTION 1: GLOBAL VARIABLES & CONFIGURATION
    // =========================================================================
    
    // --- GAME ENGINE ---
    let currentQIndex = 0;
    let maxHP = 1000;
    let currentHP = maxHP;
    let timeLeft = 1200; 
    let timerInterval;
    let peekInterval; // For the "Cursed Word" peek mechanic

    // --- BOSS STATS ---
    let bossMana = 0;
    const MANA_PASSIVE_RATE = 0.1; // Fills 0.4% every 100ms
    const MANA_PENALTY = 25;       // +25% charge on wrong answer
    let bossSkillCycle = 0;
    let activeBossTimer = null;    // Tracks the 10s duration of boss skills
    let isAbilityActive = false;   // True when boss is currently attacking

    // --- HERO STATS (THE FIX) ---
    let playerFocus = 0;           // Current Blue Bars
    const MAX_FOCUS = 5;           // Max Blue Bars (Needed for Ultimate)
    
    let chargeProgress = 0;        // Internal counter (0, 1, 2)
    const CHARGE_REQ = 2;          // 3 Correct Answers = 1 Blue Bar
    
    let isSniperActive = false;    // Flag for Precision Strike Ability
    let baseDamage = 15; 
    let comboStreak = 0;

    // --- AUDIO CONTEXT ---
    const synth = window.speechSynthesis;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();


    // =========================================================================
    // SECTION 2: AUDIO ENGINE (MP3 BASED)
    // =========================================================================

    console.log(">> AUDIO ENGINE LOADING..."); 

    const soundMap = {
        // GENERAL
        'win': 'sfx_win.mp3',
        'lose': 'sfx_lose.mp3',
        'charge_complete': 'sfx_charge.mp3',

        // HERO TOOLS
        'tool_cut': 'sfx_tool_cut.mp3',
        'tool_scan': 'sfx_tool_scan.mp3',
        'tool_logic': 'sfx_tool_logic.mp3',

        // HERO ABILITIES
        'slash': 'sfx_ability_slash.mp3',
        'scan_activate': 'sfx_ability_chain.mp3',
        'sniper_load': 'sfx_ability_sniper.mp3',
        'gunshot': 'sfx_gunshot.mp3',

        // BOSS ABILITIES
        'boss_magic': 'sfx_boss_curse.mp3',
        'boss_lock': 'sfx_boss_lock.mp3',
        'boss_glitch': 'sfx_boss_glitch.mp3'
    };

    function playSound(key) {
        const filename = soundMap[key];
        
        if (!filename) {
            console.error(`>> AUDIO ERROR: Key '${key}' not found in soundMap.`);
            return;
        }

        const audio = new Audio(filename);
        audio.volume = 0.5; 
        
        const playPromise = audio.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.warn(`>> PLAY ERROR: Could not play '${filename}'.`);
            });
        }
    }

    // --- VISUAL FX ---
    function triggerVisualFX(type) {
        const overlay = document.getElementById(type === 'win' ? 'healOverlay' : 'damageOverlay');
        if(!overlay) return;
        const animClass = type === 'win' ? 'trigger-heal' : 'trigger-damage';
        overlay.classList.remove(animClass);
        void overlay.offsetWidth; 
        overlay.classList.add(animClass);
    }

    function spawnDamageNumber(amount) {
        const sidebar = document.querySelector('.boss-sidebar');
        if(!sidebar) return;
        const num = document.createElement('div');
        num.classList.add('damage-number');
        num.innerText = "-" + amount.toFixed(0);
        const randomX = Math.random() * 50 + 50; 
        const randomY = Math.random() * 50 + 100;
        num.style.left = randomX + "px";
        num.style.top = randomY + "px";
        sidebar.appendChild(num);
        setTimeout(() => num.remove(), 1000);
    }

    function showFeedback(isGood, msg) {
        const fb = document.getElementById('fbModal');
        fb.style.display = 'block';
        fb.style.borderColor = isGood ? 'var(--green)' : 'var(--red)';
        fb.style.color = isGood ? 'var(--green)' : 'var(--red)';
        fb.innerText = msg;
        setTimeout(() => fb.style.display = 'none', 2000);
    }
    
    // Fallbacks
    function playTone() {}
    function sfxSplat() {} 
    function sfxLock() {} 
    function sfxMagic() {}
    function sfxGlitch() {}


    // =========================================================================
    // SECTION 3: GAUNTLET DATA STORE
    // =========================================================================

    // --- ROUND 1: INTERMEDIATE (B2) - FINAL POLISHED ---
const round1Data = {
    passages: [
        { 
            id: 1, 
            title: "TEXT 1: THE COFFEE REVOLUTION", 
            content: `<div class="news-wrapper"><div class="news-body"><p>The <span class="adj-word">global</span> transformation of coffee culture began in the <span class="adj-word">Arabian</span> Peninsula. While legends speak of <span class="adj-word">energetic</span> goats, the <span class="adj-word">historical</span> reality is one of <span class="adj-word">systematic</span> cultivation. By the 15th century, coffee was not merely a beverage but a <span class="adj-word">social</span> catalyst.</p><p><span class="connector">Consequently</span>, the emergence of the coffee house created a <span class="adj-word">unique</span> space for <span class="adj-word core">intellectual</span> exchange. These establishments were <span class="adj-word junk">unprecedented</span> in their ability to mix <span class="adj-word">social</span> classes. <span class="connector">However</span>, this openness led to <span class="adj-word">political</span> paranoia.</p><p><span class="connector">Ultimately</span>, despite attempts to ban it, the <span class="adj-word">immense</span> popularity of coffee proved <span class="adj-word core">irrepressible</span>.</p></div></div>` 
        },
        { 
            id: 2, 
            title: "TEXT 2: THE DIGITAL NOMAD", 
            content: `<div class="academic-text"><p>Digital nomadism represents a <span class="adj-word">radical</span> decentralization of the <span class="adj-word">traditional</span> workforce. Facilitated by <span class="adj-word core">technological</span> advancements, workers are no longer tethered to a <span class="adj-word">physical</span> office. <span class="connector">However</span>, this lifestyle is often romanticized.</p><p>The reality involves <span class="adj-word junk">significant</span> psychological challenges. The disconnection from a <span class="adj-word">stable</span> community can lead to <span class="adj-word">profound</span> loneliness. <span class="connector">Furthermore</span>, without structure, the boundary between work and leisure becomes <span class="adj-word junk">indistinguishable</span>.</p><p><span class="connector">Therefore</span>, while the freedom is <span class="adj-word">appealing</span>, the sustainability depends on <span class="adj-word">individual</span> adaptability.</p></div>` 
        },
        { 
            id: 3, 
            title: "TEXT 3: APICULTURE (BEES)", 
            content: `<div class="log-wrapper"><div class="log-header">// ECOLOGY REPORT</div><div class="log-body"><div class="log-entry">Honey bees demonstrate a <span class="adj-word">complex</span> level of interdependence. The colony operates as a "superorganism," where <span class="adj-word">individual</span> survival is <span class="adj-word junk">impossible</span> without the group.</div><br><div class="log-entry">The specialization is <span class="adj-word">strict</span>: The Queen focuses on reproduction, while Workers manage resources. <span class="connector">Crucially</span>, their role as pollinators makes them <span class="adj-word core">irreplaceable</span>.</p><br><div class="log-entry"><span class="connector">Conversely</span>, "Colony Collapse Disorder" highlights their vulnerability. The <span class="adj-word junk">rapid</span> disappearance of worker bees leads to <span class="adj-word">catastrophic</span> failure.</div></div></div>` 
        },
        { 
            id: 4, 
            title: "TEXT 4: URBAN DEVELOPMENT", 
            content: `<div class="transcript-box"><div class="speech-bubble guest"><span class="speaker">RESIDENT SARA</span><p>The proposal to construct a mall is <span class="adj-word junk">unacceptable</span>. This project prioritizes <span class="adj-word">commercial</span> development over <span class="adj-word core">environmental</span> preservation.</p><p><span class="connector">Moreover</span>, the traffic assessment is <span class="adj-word junk">insufficient</span>. It fails to account for <span class="adj-word">current</span> congestion. <span class="connector">Although</span> the council promises jobs, they are <span class="adj-word">temporary</span>.</p><p><span class="connector">Instead</span>, we should focus on the revitalization of <span class="adj-word">local</span> businesses. Destroying our <span class="adj-word">only</span> green space is an <span class="adj-word junk">irreversible</span> mistake.</p></div></div>` 
        }
    ],
    questions: [
        // --- TEXT 1: COFFEE ---
        { tId: 1, q: "1. Why were coffee houses historically referred to as 'Schools of the Wise'?", opts: ["A. They were originally located inside major university campuses.", "B. They were exclusive clubs reserved only for scholars.", "C. They served as hubs for intellectual discussion and news.", "D. They offered formal classes on mathematics.", "E. They required patrons to pass a test before entering."], ans: 2 }, // C
        { tId: 1, q: "2. Which statement accurately reflects the origins of coffee according to the text?", opts: ["A. It was first cultivated systematically in the Arabian Peninsula.", "B. It was discovered by a goat herder in Turkey.", "C. It was invented by Persians as a medicinal cure.", "D. It was originally banned in Ethiopia for religious reasons.", "E. It was brought to Mecca by European traders."], ans: 0 }, // A
        { tId: 1, q: "3. The word 'energetic' regarding the goats is best replaced by:", opts: ["A. Aggressive and dangerous.", "B. Intelligent and aware.", "C. Sleepy and lethargic.", "D. Hungry and thirsty.", "E. Active and lively."], ans: 4 }, // E
        { tId: 1, q: "4. What was the 'unprecedented' social aspect of the coffee house?", opts: ["A. It allowed women to own businesses.", "B. It allowed different social classes to mix freely.", "C. It served food alongside beverages.", "D. It stayed open 24 hours a day.", "E. It was funded by the government."], ans: 1 }, // B
        { tId: 1, q: "5. Why did some rulers view coffee houses with suspicion?", opts: ["A. They believed coffee was a poisonous substance.", "B. They feared the spread of foreign diseases.", "C. They wanted to protect the tea industry.", "D. They worried the houses were centers for political sedition.", "E. They disliked the music played there."], ans: 3 }, // D

        // --- TEXT 2: DIGITAL NOMADS ---
        { tId: 2, q: "6. What is the main idea regarding the 'reality' of digital nomadism?", opts: ["A. It is the most profitable career path available.", "B. It is entirely free of stress and responsibility.", "C. It involves significant psychological challenges like loneliness.", "D. It is legally prohibited in most Asian countries.", "E. It requires expensive equipment to be successful."], ans: 2 }, // C
        { tId: 2, q: "7. The text mentions all of the following as challenges EXCEPT:", opts: ["A. Profound feelings of loneliness.", "B. High cost of visa applications.", "C. Lack of a structured environment.", "D. Difficulty maintaining a routine.", "E. Blurred boundaries between work and leisure."], ans: 1 }, // B
        { tId: 2, q: "8. Why is 'self-discipline' cited as a crucial skill?", opts: ["A. Because nomads must wake up at 5:00 AM every day.", "B. Because travel requires strict physical fitness.", "C. Because local laws often require it.", "D. Because there is no external structure to enforce work hours.", "E. Because internet access is limited."], ans: 3 }, // D
        { tId: 2, q: "9. The word 'indistinguishable' implies that work and leisure:", opts: ["A. Have blended together confusingly.", "B. Are no longer valued by society.", "C. Have become clearly separated.", "D. Are equally profitable.", "E. Have become illegal."], ans: 0 }, // A
        { tId: 2, q: "10. The success or 'sustainability' of this lifestyle depends primarily on:", opts: ["A. The speed of the internet connection.", "B. The amount of money saved.", "C. The individual's ability to adapt.", "D. The political stability of the host country.", "E. The type of laptop used."], ans: 2 }, // C

        // --- TEXT 3: BEES ---
        { tId: 3, q: "11. The term 'superorganism' refers to the fact that:", opts: ["A. Bees are larger than other insects.", "B. Individual survival is impossible without the group.", "C. The colony is ruled by a dictator.", "D. Bees can survive in space.", "E. The Queen controls the minds of workers."], ans: 1 }, // B
        { tId: 3, q: "12. What is the primary function of the Queen bee?", opts: ["A. To defend the hive from attackers.", "B. To collect nectar from flowers.", "C. To build the honeycomb structure.", "D. To train the younger bees.", "E. To reproduce by laying eggs."], ans: 4 }, // E
        { tId: 3, q: "13. Why are bees considered 'irreplaceable'?", opts: ["A. They produce expensive honey.", "B. They are the only insects that can fly.", "C. They play a critical role as pollinators.", "D. They have a unique color pattern.", "E. They are friendly to humans."], ans: 2 }, // C
        { tId: 3, q: "14. Colony Collapse Disorder is characterized by:", opts: ["A. The rapid disappearance of worker bees.", "B. The sudden death of the Queen.", "C. An invasion of killer hornets.", "D. The hive filling with too much honey.", "E. The bees becoming aggressive."], ans: 0 }, // A
        { tId: 3, q: "15. The 'specialization' mentioned in the text refers to:", opts: ["A. The ability to see ultraviolet light.", "B. The strict division of labor/roles.", "C. The dance language of bees.", "D. The shape of the stinger.", "E. The type of flowers they visit."], ans: 1 }, // B

        // --- TEXT 4: SARA'S LETTER ---
        { tId: 4, q: "16. What is Sara's primary objection to the mall project?", opts: ["A. It will be too noisy for the neighbors.", "B. The architecture is ugly and modern.", "C. It will compete with her own business.", "D. It prioritizes commerce over environmental preservation.", "E. It is being built by a foreign company."], ans: 3 }, // D
        { tId: 4, q: "17. Sara argues that the traffic assessment is 'insufficient' because:", opts: ["A. It was conducted by a corrupt official.", "B. It used outdated technology.", "C. It fails to account for current congestion.", "D. It was done during the night.", "E. It ignored the pedestrian walkways."], ans: 2 }, // C
        { tId: 4, q: "18. What criticism does Sara make regarding the promised jobs?", opts: ["A. They will require high-level degrees.", "B. They will be given to non-residents.", "C. They are dangerous construction jobs.", "D. They are typically low-wage and temporary.", "E. They will not include health insurance."], ans: 3 }, // D
        { tId: 4, q: "19. Sara's proposed alternative solution is to:", opts: ["A. Build the mall in a different district.", "B. Revitalize existing local businesses.", "C. Create a new park elsewhere.", "D. Ban all cars from the area.", "E. Cancel the project and do nothing."], ans: 1 }, // B
        { tId: 4, q: "20. The phrase 'irreversible mistake' implies that:", opts: ["A. The mall will be very expensive.", "B. The city council will lose the next election.", "C. The damage to the green space cannot be undone.", "D. The traffic will never stop.", "E. The economy will collapse."], ans: 2 } // C
    ]
};

    // --- PLACEHOLDERS FOR FUTURE ROUNDS (WE WILL FILL THESE LATER) ---
    // --- ROUND 2: ADVANCED (C1 LEVEL) ---
    // --- ROUND 2: ADVANCED (C1) - EXPANDED & TOOL-READY ---
// --- ROUND 2: ADVANCED (C1) - FINAL POLISHED ---
const round2Data = {
    passages: [
        { 
            id: 1, 
            title: "TEXT 1: THE PARADOX OF CHOICE", 
            content: `<div class="academic-text"><p>In <span class="adj-word">modern</span> industrial societies, the <span class="adj-word">official</span> dogma suggests that maximizing choice maximizes freedom. <span class="connector">However</span>, this assumption overlooks the <span class="adj-word junk">psychological</span> cost of decision-making. Barry Schwartz identifies a <span class="adj-word">pervasive</span> phenomenon known as "Choice Paralysis." When options are <span class="adj-word junk">overwhelming</span>‚Äîwhether in a supermarket aisle or a retirement plan‚Äîthe <span class="adj-word">cognitive</span> load increases drastically.</p><p><span class="connector">Consequently</span>, even if a choice is made, the <span class="adj-word junk">nagging</span> anticipation of regret diminishes satisfaction. This is the "Opportunity Cost" of the unchosen paths. The chooser is haunted by the <span class="adj-word">imagined</span> benefits of the rejected alternatives.</p><p><span class="connector">Thus</span>, the <span class="adj-word">perpetual</span> search for the <span class="adj-word">perfect</span> option leads to misery. The "Satisficer," who accepts what is 'good enough', is often <span class="adj-word core">happier</span> than the "Maximizer" who seeks <span class="adj-word">absolute</span> perfection.</p></div>` 
        },
        { 
            id: 2, 
            title: "TEXT 2: FAST FASHION'S TOLL", 
            content: `<div class="news-wrapper"><div class="news-body"><p>Fast fashion is characterized by the <span class="adj-word junk">accelerated</span> production of <span class="adj-word">low-cost</span> garments to mirror <span class="adj-word">current</span> trends. While this <span class="adj-word core">democratization</span> of style allows <span class="adj-word">frequent</span> consumption, it relies on a <span class="adj-word">predatory</span> model of <span class="adj-word core">planned</span> obsolescence. The clothes are designed to be <span class="adj-word">disposable</span>.</p><p><span class="connector">Furthermore</span>, the <span class="adj-word">environmental</span> implications are <span class="adj-word junk">devastating</span>. The industry creates <span class="adj-word junk">non-biodegradable</span> waste and consumes <span class="adj-word">vast</span> quantities of water. <span class="connector">Despite</span> <span class="adj-word">flashy</span> sustainability marketing campaigns, the <span class="adj-word">core</span> business model remains <span class="adj-word junk">unsustainable</span>.</p><p><span class="connector">Unless</span> consumer behavior shifts from <span class="adj-word junk">impulsive</span> buying to <span class="adj-word">mindful</span> consumption, the <span class="adj-word">ecological</span> damage will be <span class="adj-word junk">irreversible</span>.</p></div></div>` 
        },
        { 
            id: 3, 
            title: "TEXT 3: THE KESSLER SYNDROME", 
            content: `<div class="log-wrapper"><div class="log-header">// ORBITAL ANALYSIS</div><div class="log-body"><div class="log-entry">The <span class="adj-word">rapid</span> proliferation of satellites in Low Earth Orbit has created a <span class="adj-word junk">hazardous</span> density of debris. The "Kessler Syndrome" posits a <span class="adj-word junk">catastrophic</span> scenario of <span class="adj-word">cascading</span> collisions.</div><br><div class="log-entry">In this scenario, a <span class="adj-word">single</span> hypervelocity impact generates a cloud of shrapnel, which <span class="connector">subsequently</span> increases the probability of <span class="adj-word">further</span> impacts. <span class="connector">Ultimately</span>, this chain reaction could form an <span class="adj-word junk">impenetrable</span> barrier of <span class="adj-word">metallic</span> waste around the planet.</div><br><div class="log-entry">This would result in the <span class="adj-word">complete</span> inaccessibility of space for <span class="adj-word">future</span> generations, essentially trapping humanity on Earth due to our own <span class="adj-word">collective</span> negligence.</div></div></div>` 
        },
        { 
            id: 4, 
            title: "TEXT 4: ALGORITHMIC BIAS", 
            content: `<div class="transcript-box"><div class="speech-bubble guest"><span class="speaker">DR. VANCE</span><p>The notion of algorithmic neutrality is a <span class="adj-word junk">dangerous</span> misconception. We assume computers are <span class="adj-word">objective</span>, but since AI is trained on <span class="adj-word">historical</span> data, it <span class="adj-word">inadvertently</span> absorbs <span class="adj-word">deep-seated</span> human prejudices.</p><p><span class="connector">For example</span>, a hiring algorithm might penalize women simply because the <span class="adj-word">past</span> data reflects a <span class="adj-word">male-dominated</span> industry. The machine is not 'thinking'; it is performing <span class="adj-word core">statistical</span> replication of <span class="adj-word">past</span> errors. <span class="connector">Therefore</span>, without <span class="adj-word">active</span> correction, AI serves to automate and amplify <span class="adj-word">existing</span> discrimination rather than eliminate it.</p><p><span class="connector">In conclusion</span>, true fairness requires <span class="adj-word core">human</span> intervention, not <span class="adj-word junk">blind</span> trust in the code.</p></div></div>` 
        }
    ],
    questions: [
        // --- TEXT 1: PARADOX OF CHOICE ---
        { tId: 1, q: "1. What is the central thesis of Barry Schwartz's 'Paradox of Choice'?", opts: ["A. Freedom is the single most important value in modern society.", "B. People should always strive to find the absolute best option.", "C. Having excessive options leads to anxiety and dissatisfaction.", "D. Marketing strategies effectively manipulate consumer choices.", "E. The financial cost of a decision is usually negligible."], ans: 2 }, // C
        { tId: 1, q: "2. The word 'prevailing' in the first paragraph implies that the belief is:", opts: ["A. Incorrect and scientifically flawed.", "B. Ancient and outdated by modern standards.", "C. Widespread and dominant in society.", "D. Controversial and heavily debated.", "E. Proven by rigorous economic data."], ans: 2 }, // C
        { tId: 1, q: "3. How does a 'Maximizer' differ from a 'Satisficer'?", opts: ["A. A Maximizer makes decisions quickly; a Satisficer takes their time.", "B. A Maximizer seeks the absolute best; a Satisficer accepts 'good enough'.", "C. A Maximizer spends more money than a Satisficer.", "D. A Maximizer ignores advice; a Satisficer listens to others.", "E. A Maximizer is generally happier than a Satisficer."], ans: 1 }, // B
        { tId: 1, q: "4. Why does 'Opportunity Cost' lead to dissatisfaction?", opts: ["A. Because the rejected options would have cost more money.", "B. Because it forces the individual to return the purchased item.", "C. Because it reduces the number of future choices available.", "D. Because the individual imagines the unchosen alternative was better.", "E. Because it physically drains the brain's energy."], ans: 3 }, // D
        { tId: 1, q: "5. The author's tone regarding the 'official dogma' of choice is:", opts: ["A. Critical and analytical.", "B. Supportive and admiring.", "C. Indifferent and detached.", "D. Angry and aggressive.", "E. Confused and hesitant."], ans: 0 }, // A

        // --- TEXT 2: FAST FASHION ---
        { tId: 2, q: "6. The phrase 'democratizes style' implies that fast fashion:", opts: ["A. Allows the public to vote on new trends.", "B. Is controlled by political parties.", "C. Makes fashionable clothing affordable for the masses.", "D. Ensures high quality clothing for everyone.", "E. Promotes ethical labor standards."], ans: 2 }, // C
        { tId: 2, q: "7. All of the following are cited as negative impacts EXCEPT:", opts: ["A. Excessive consumption of water resources.", "B. Exploitation of underage labor forces.", "C. Release of microplastics and waste.", "D. Increased global carbon emissions.", "E. Creation of a culture of disposability."], ans: 1 }, // B
        { tId: 2, q: "8. The word 'ramifications' could best be replaced by:", opts: ["A. Benefits.", "B. Origins.", "C. Requirements.", "D. Consequences.", "E. Explanations."], ans: 3 }, // D
        { tId: 2, q: "9. The 'cycle' mentioned in the final paragraph refers to:", opts: ["A. The recycling of polyester fibers.", "B. The seasonal changes of fashion trends.", "C. Repetitive buying driven by psychological reward.", "D. The water cycle affected by pollution.", "E. The economic growth of companies."], ans: 2 }, // C
        { tId: 2, q: "10. The primary obstacle to sustainability mentioned is:", opts: ["A. Lack of recycling technology.", "B. Government regulations.", "C. Consumer behavior (impulse buying).", "D. High cost of organic cotton.", "E. Scarcity of water."], ans: 2 }, // C

        // --- TEXT 3: KESSLER SYNDROME ---
        { tId: 3, q: "11. The 'Kessler Syndrome' describes a scenario where:", opts: ["A. Aliens invade Earth from orbit.", "B. Satellites stop working due to solar flares.", "C. Earth's gravity pulls the moon closer.", "D. Cascading collisions create an impenetrable debris field.", "E. Astronauts suffer from muscle atrophy."], ans: 3 }, // D
        { tId: 3, q: "12. What is the 'debris shield' mentioned in the text?", opts: ["A. A protective barrier built by NASA.", "B. A cloud of shrapnel preventing space travel.", "C. A layer of ozone protecting Earth.", "D. A new technology to clean up junk.", "E. A magnetic field generated by satellites."], ans: 1 }, // B
        { tId: 3, q: "13. The word 'posits' is synonymous with:", opts: ["A. Denies.", "B. Proves.", "C. Suggests.", "D. Calculates.", "E. Observes."], ans: 2 }, // C
        { tId: 3, q: "14. A likely consequence of the Kessler Syndrome is:", opts: ["A. Cheaper space travel.", "B. Humanity being trapped on Earth.", "C. Better weather forecasting.", "D. Faster discovery of planets.", "E. Expansion of the ISS."], ans: 1 }, // B
        { tId: 3, q: "15. The text implies the problem in LEO is:", opts: ["A. Solving itself naturally.", "B. Caused by asteroids.", "C. Self-perpetuating once started.", "D. Easily fixed with lasers.", "E. Not a serious threat."], ans: 2 }, // C

        // --- TEXT 4: ALGORITHMIC BIAS ---
        { tId: 4, q: "16. Why is algorithmic neutrality a 'misconception'?", opts: ["A. Computers make mathematical errors.", "B. They are trained on biased historical data.", "C. They are programmed to be malicious.", "D. They cannot understand language.", "E. They are too slow to process data."], ans: 1 }, // B
        { tId: 4, q: "17. The hiring algorithm example shows how AI can:", opts: ["A. Improve workplace diversity.", "B. Select candidates objectively.", "C. Automate and amplify discrimination.", "D. Replace human managers.", "E. Predict future trends."], ans: 2 }, // C
        { tId: 4, q: "18. In 'eliminate it', the word 'it' refers to:", opts: ["A. The algorithm.", "B. The hiring process.", "C. Discrimination.", "D. The data.", "E. The industry."], ans: 2 }, // C
        { tId: 4, q: "19. The relationship between AI and history is:", opts: ["A. AI ignores history.", "B. AI corrects past mistakes.", "C. AI replicates historical patterns.", "D. AI deletes historical data.", "E. AI creates new history."], ans: 2 }, // C
        { tId: 4, q: "20. The author concludes that we need:", opts: ["A. To stop using computers immediately.", "B. Active human intervention to correct bias.", "C. Algorithms that only process math.", "D. To ban all artificial intelligence.", "E. To trust the code completely."], ans: 1 } // B
    ]
};
    // --- ROUND 3: HIGH C1 (SCHOLASTIC / UTBK HARD) ---
// --- ROUND 3: HIGH C1 (SCHOLASTIC / UTBK HARD) - FINAL POLISHED ---
const round3Data = {
    passages: [
        { 
            id: 1, 
            title: "TEXT 1: LINGUISTIC RELATIVITY", 
            content: `<div class="academic-text">
                <p>The Sapir-Whorf hypothesis, or linguistic relativity, posits that the <span class="adj-word">syntactic</span> structure of a language affects its speakers' world view. In its <span class="adj-word junk">strong</span> form, known as linguistic determinism, it claims language <span class="adj-word">rigidly</span> <em>determines</em> thought; in its <span class="adj-word core">weak</span> form, it merely <em>influences</em> cognition. <span class="connector">Historically</span>, early proponents like Benjamin Lee Whorf argued that the Hopi people perceive time <span class="adj-word">differently</span> because their language lacks <span class="adj-word">standard</span> grammatical tenses. <span class="connector">However</span>, universalist critics like Noam Chomsky dismissed this, arguing that all languages share a <span class="adj-word">fundamental</span> "Universal Grammar" that exists <span class="adj-word">prior</span> to culture.</p>
                <p><span class="connector">Nevertheless</span>, the debate has seen a <span class="adj-word">robust</span> resurgence in <span class="adj-word">recent</span> cognitive science. Studies on "grammatical gender" suggest a <span class="adj-word">subtle</span> but <span class="adj-word">pervasive</span> cognitive bias. For instance, <span class="adj-word">inanimate</span> objects like bridges are described as "<span class="adj-word">strong</span>" or "<span class="adj-word">sturdy</span>" in German (where the word is <span class="adj-word">masculine</span>) but "<span class="adj-word">elegant</span>" or "<span class="adj-word">slender</span>" in Spanish (where it is <span class="adj-word">feminine</span>).</p>
                <p><span class="connector">Furthermore</span>, spatial cognition varies <span class="adj-word">drastically</span>. The Guugu Yimithirr people of Australia use <span class="adj-word core">cardinal</span> directions (North/South) exclusively, rather than <span class="adj-word junk">egocentric</span> ones (Left/Right). <span class="connector">Consequently</span>, they possess an <span class="adj-word">absolute</span> sense of orientation that <span class="adj-word">standard</span> English speakers lack. <span class="connector">Thus</span>, while language may not be a prison, it acts as a <span class="adj-word">powerful</span> perceptual filter.</p>
            </div>` 
        },
        { 
            id: 2, 
            title: "TEXT 2: QUANTUM ENTANGLEMENT", 
            content: `<div class="log-wrapper"><div class="log-header">// PHYSICS ARCHIVE</div><div class="log-body">
                <div class="log-entry">In 1935, Albert Einstein, along with colleagues Podolsky and Rosen, published the famous EPR paper challenging quantum mechanics. They derisively described a <span class="adj-word">theoretical</span> anomaly as "spooky action at a distance." This phenomenon, known as Quantum Entanglement, describes a <span class="adj-word">bizarre</span> scenario where particles remain <span class="adj-word">intricately</span> connected so that the <span class="adj-word">physical</span> state of one is <span class="adj-word core">instantly</span> correlated with the other, regardless of <span class="adj-word">vast</span> distances.</div>
                <br>
                <div class="log-entry">This violates the <span class="adj-word">classical</span> principle of "locality," which dictates that objects are only influenced by their <span class="adj-word">immediate</span> surroundings and that information cannot travel faster than light. Einstein argued this proved Quantum Mechanics was <span class="adj-word junk">incomplete</span> and postulated the existence of "Hidden Variables."</div>
                <br>
                <div class="log-entry"><span class="connector">However</span>, decades later, experiments testing Bell's Theorem <span class="adj-word">consistently</span> proved Einstein wrong. The results confirmed that no <span class="adj-word">local</span> hidden variables exist. The <span class="adj-word">inescapable</span> implication is that the universe is <span class="adj-word core">fundamentally</span> non-local. This challenges our <span class="adj-word">intuitive</span> understanding of reality, suggesting that at a <span class="adj-word">quantum</span> level, spatial separation is an <span class="adj-word junk">illusion</span>.</div>
            </div></div>` 
        },
        { 
            id: 3, 
            title: "TEXT 3: GAME THEORY & COMMONS", 
            content: `<div class="academic-text">
                <p>The "Tragedy of the Commons," popularized by Garrett Hardin in 1968, illustrates a <span class="adj-word">grim</span> economic dilemma. It posits that individuals acting according to <span class="adj-word">rational</span> self-interest will <span class="adj-word">inevitably</span> deplete a <span class="adj-word">shared</span> resource, behaving <span class="adj-word">contrary</span> to the long-term common good. Hardin argued that freedom in a commons brings ruin to all, proposing only two solutions: <span class="adj-word">centralized</span> government regulation or <span class="adj-word">total</span> privatization.</p>
                <p><span class="connector">Conversely</span>, Elinor Ostrom's Nobel-winning work empirically demonstrated that this <span class="adj-word junk">cynical</span> outcome is not a law of nature. Through <span class="adj-word">extensive</span> field studies, Ostrom found that <span class="adj-word">local</span> communities often develop <span class="adj-word core">polycentric</span> governance systems‚Äîcomplex arrangements of <span class="adj-word">informal</span> rules and <span class="adj-word">social</span> norms‚Äîthat manage resources <span class="adj-word">sustainably</span> without <span class="adj-word">top-down</span> force.</p>
                <p>She identified core principles, such as <span class="adj-word">collective</span> choice arrangements and <span class="adj-word">graduated</span> sanctions for violators, which allow groups to self-organize. <span class="connector">Therefore</span>, the dichotomy between "State" and "Market" is <span class="adj-word junk">false</span>; human cooperation is significantly more <span class="adj-word">robust</span> than <span class="adj-word">classical</span> economic models predict.</p>
            </div>` 
        },
        { 
            id: 4, 
            title: "TEXT 4: THE DOCTRINE OF LACHES", 
            content: `<div class="news-wrapper"><div class="news-body">
                <p>In the <span class="adj-word">complex</span> realm of legal equity, the "Doctrine of Laches" serves as a defense against <span class="adj-word">stale</span> claims. It asserts that a legal right will not be enforced if a <span class="adj-word junk">long</span> delay in asserting that right has prejudiced the <span class="adj-word">adverse</span> party. The doctrine is derived from the <span class="adj-word">ancient</span> maxim: "Equity aids the <span class="adj-word core">vigilant</span>, not those who slumber on their rights."</p>
                <p><span class="connector">Unlike</span> a Statute of Limitations, which is a <span class="adj-word">rigid</span>, <span class="adj-word">legislative</span> time period, Laches is <span class="adj-word">inherently</span> subjective and flexible. It focuses not on the clock, but on the <span class="adj-word">fairness</span> of the delay. To successfully invoke Laches, a defendant must prove two elements: unreasonable delay by the plaintiff, and <span class="adj-word">resulting</span> prejudice to the defendant.</p>
                <p><span class="connector">For example</span>, if a plaintiff waits ten years to sue for a <span class="adj-word">minor</span> property line dispute, and during that time the defendant invests millions to build a factory on the land, the court may rule that the plaintiff's inaction implies <span class="adj-word core">tacit</span> acquiescence. <span class="connector">Thus</span>, Laches prevents the weaponization of <span class="adj-word">strategic</span> delay.</p>
            </div></div>` 
        }
    ],
    questions: [
        // --- TEXT 1: LINGUISTICS ---
        { 
            tId: 1, 
            q: "1. The 'strong form' of the Sapir-Whorf hypothesis implies that:", 
            opts: [
                "A. Translation between different languages is strictly impossible.", 
                "B. Language merely influences but does not constrain the mind.", 
                "C. Grammar is a biological trait shared by all humans.", 
                "D. People can think of concepts even if they lack the words.", 
                "E. If a word does not exist in your language, you cannot think the concept."
            ], 
            ans: 4 // E
        },
        { 
            tId: 1, 
            q: "2. The example of the 'bridge' in German vs. Spanish illustrates:", 
            opts: [
                "A. How grammatical gender influences conceptual association.", 
                "B. The engineering differences between German and Spanish bridges.", 
                "C. The universal nature of grammatical structures across Europe.", 
                "D. That translation errors are common in diplomatic relations.", 
                "E. That bridges are viewed as masculine objects in all cultures."
            ], 
            ans: 0 // A
        },
        { 
            tId: 1, 
            q: "3. What is the main contrast between 'cardinal' and 'egocentric' directions?", 
            opts: [
                "A. One is based on scientific magnetic poles, the other on cultural tradition.", 
                "B. One relies on fixed coordinates (N/S), the other on relative body position (L/R).", 
                "C. One is primarily used for maritime navigation, the other for land travel.", 
                "D. One is considered primitive by linguists, the other is considered advanced.", 
                "E. One allows for absolute orientation, while the other is more accurate."
            ], 
            ans: 1 // B
        },
        { 
            tId: 1, 
            q: "4. The word 'posits' in the first sentence is synonymous with:", 
            opts: [
                "A. Denies / Refutes.", 
                "B. Suggests / Hypothesizes.", 
                "C. Proves / Demonstrates.", 
                "D. Calculates / Measures.", 
                "E. Observes / Witnesses."
            ], 
            ans: 1 // B
        },
        { 
            tId: 1, 
            q: "5. The author's conclusion about language is that it acts as:", 
            opts: [
                "A. A perceptual filter that shapes how we see reality.", 
                "B. An irrelevant noise that has no impact on thought.", 
                "C. A prison wall that makes cross-cultural understanding impossible.", 
                "D. A perfect mirror that reflects reality without distortion.", 
                "E. A genetic mutation that separates humans from animals."
            ], 
            ans: 0 // A
        },

        // --- TEXT 2: QUANTUM MECHANICS ---
        { 
            tId: 2, 
            q: "6. Why did Einstein object to quantum entanglement?", 
            opts: [
                "A. Because he did not understand the advanced mathematics involved.", 
                "B. Because it required particles to move faster than the speed of light.", 
                "C. Because it violated the principle of locality and appeared 'spooky'.", 
                "D. Because it disproved his earlier theories on gravity and relativity.", 
                "E. Because it required infinite energy to sustain the connection."
            ], 
            ans: 2 // C
        },
        { 
            tId: 2, 
            q: "7. What does 'non-local' mean in this context?", 
            opts: [
                "A. Existing outside of the Milky Way galaxy.", 
                "B. Not originating from the planet Earth.", 
                "C. Restricted to a single, isolated laboratory environment.", 
                "D. Capable of influencing events instantly across vast distances.", 
                "E. Moving significantly slower than the speed of light."
            ], 
            ans: 3 // D
        },
        { 
            tId: 2, 
            q: "8. The text implies that our 'classical' understanding of physics involves:", 
            opts: [
                "A. Objects only affecting their immediate surroundings.", 
                "B. Magic, superstition, and supernatural elements.", 
                "C. The ability to travel faster than light.", 
                "D. Telepathic communication between humans.", 
                "E. The existence of infinite renewable energy."
            ], 
            ans: 0 // A
        },
        { 
            tId: 2, 
            q: "9. The word 'illusion' in the final sentence suggests that:", 
            opts: [
                "A. Space does not actually exist in any form.", 
                "B. Distance is not a fundamental barrier at the quantum level.", 
                "C. The entire field of physics is a lie.", 
                "D. We are living in a computer simulation.", 
                "E. Scientists have been tricking the public."
            ], 
            ans: 1 // B
        },
        { 
            tId: 2, 
            q: "10. Bell's Theorem is mentioned to support the idea that:", 
            opts: [
                "A. Einstein was correct about Hidden Variables.", 
                "B. Time travel is theoretically possible.", 
                "C. Locality is false and the universe is non-local.", 
                "D. Gravity is actually a wave, not a force.", 
                "E. Atoms are solid objects that cannot be split."
            ], 
            ans: 2 // C
        },

        // --- TEXT 3: GAME THEORY ---
        { 
            tId: 3, 
            q: "11. Elinor Ostrom's research challenged the 'Tragedy of the Commons' by showing that:", 
            opts: [
                "A. Humans are naturally selfish and destructive.", 
                "B. Natural resources are effectively infinite.", 
                "C. Privatization is the only viable solution.", 
                "D. The tragedy is an inevitable law of nature.", 
                "E. Communities can self-regulate without government force."
            ], 
            ans: 4 // E
        },
        { 
            tId: 3, 
            q: "12. What is 'polycentric governance'?", 
            opts: [
                "A. A dictatorship controlled by a single leader.", 
                "B. A global government that manages all resources.", 
                "C. A strict mathematical formula for economy.", 
                "D. A system with many centers of decision-making (informal rules).", 
                "E. A type of currency used in ancient times."
            ], 
            ans: 3 // D
        },
        { 
            tId: 3, 
            q: "13. The phrase 'top-down' refers to:", 
            opts: [
                "A. The force of gravity acting on objects.", 
                "B. Grassroots movements starting from the people.", 
                "C. Economic depression caused by market crashes.", 
                "D. The architectural process of building construction.", 
                "E. Centralized regulation imposed by a higher authority."
            ], 
            ans: 4 // E
        },
        { 
            tId: 3, 
            q: "14. The standard 'Tragedy of the Commons' model assumes humans act based on:", 
            opts: [
                "A. Rational self-interest.", 
                "B. Altruism and charity.", 
                "C. Fear of punishment.", 
                "D. Religious belief.", 
                "E. Random chance."
            ], 
            ans: 0 // A
        },
        { 
            tId: 3, 
            q: "15. The word 'robust' in the final sentence means:", 
            opts: [
                "A. Weak and fragile.", 
                "B. Expensive and rare.", 
                "C. Strong and resilient.", 
                "D. Fat and heavy.", 
                "E. Angry and loud."
            ], 
            ans: 2 // C
        },

        // --- TEXT 4: LAW (LACHES) ---
        { 
            tId: 4, 
            q: "16. The Doctrine of Laches differs from a Statute of Limitations because:", 
            opts: [
                "A. Laches is a fixed number of years set by legislation.", 
                "B. Laches is based on fairness and prejudice caused by delay.", 
                "C. Laches only applies to serious criminal murder cases.", 
                "D. Statutes are subjective and depend on the judge's mood.", 
                "E. Laches is a concept found only in French law."
            ], 
            ans: 1 // B
        },
        { 
            tId: 4, 
            q: "17. In the example provided, the plaintiff loses the case because:", 
            opts: [
                "A. The defendant paid them off with a bribe.", 
                "B. The house was built illegally without permits.", 
                "C. The statute of limitations had already passed.", 
                "D. They 'slumbered' on their rights while the defendant acted.", 
                "E. They lost the deed to the property."
            ], 
            ans: 3 // D
        },
        { 
            tId: 4, 
            q: "18. What does 'prejudiced the adverse party' mean here?", 
            opts: [
                "A. The defendant held racist views against the plaintiff.", 
                "B. The judge was biased against the defendant.", 
                "C. The delay caused unfair harm or disadvantage to the defendant.", 
                "D. The lawyer arrived late to the court session.", 
                "E. The law was written incorrectly by the government."
            ], 
            ans: 2 // C
        },
        { 
            tId: 4, 
            q: "19. The word 'tacit' implies:", 
            opts: [
                "A. Loud and clear.", 
                "B. Written down in ink.", 
                "C. Illegal or banned.", 
                "D. Accidental or mistaken.", 
                "E. Understood or implied without being stated."
            ], 
            ans: 4 // E
        },
        { 
            tId: 4, 
            q: "20. The saying 'Equity aids the vigilant' means the law favors:", 
            opts: [
                "A. Those who act promptly to protect their rights.", 
                "B. Those who stay awake all night working.", 
                "C. Those who hire the most expensive lawyers.", 
                "D. Those who are wealthy and powerful.", 
                "E. Those who are patient and wait years to sue."
            ], 
            ans: 0 // A
        }
    ]
};

    // --- MASTER CONFIG ---
    const gameConfig = [round1Data, round2Data, round3Data];
    let currentRoundIndex = 0;

    // --- ACTIVE BUFFERS (The game reads these) ---
    let passages = []; 
    let questions = [];


    // =========================================================================
    // SECTION 4: MAIN GAME ENGINE (Start/Load/Check)
    // =========================================================================
    // --- ROUND MANAGER ---

    // --- TOOL: SUFFIX CUTTER SWAP LOGIC ---
    function updateSuffixVisuals() {
        const textPanel = document.getElementById('textPanel');
        const isSuffixMode = textPanel.classList.contains('mode-suffix');
        const morphs = document.querySelectorAll('.morph');

        morphs.forEach(el => {
            if (isSuffixMode) {
                // TOOL ON: Inject HTML to strikethrough the suffix
                // We use 'innerHTML' so the <span> tags work
                el.innerHTML = el.getAttribute('data-cut'); 
            } else {
                // TOOL OFF: Show the clean word (the 'aria-label' or clean text)
                // We can just grab the text content of the HTML to strip tags
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = el.getAttribute('data-cut');
                el.innerText = tempDiv.innerText; // Removes the <span> tags
            }
        });
    }

    function loadRound(roundIdx) {
        // 1. Victory Check (If we pass Round 3)
        if (roundIdx >= gameConfig.length) {
            winGame(); // Game Over - You Win!
            return;
        }

        // 2. Load Data from the Config
        currentRoundIndex = roundIdx;
        
        // CRITICAL: Copy the data into the active buffers
        passages = [...gameConfig[roundIdx].passages];
        questions = [...gameConfig[roundIdx].questions];
        
        // 3. Reset Counters for the new round
        currentQIndex = 0;
        
        // 4. Debug / UI Update
        console.log("Loading Round: " + (roundIdx + 1));
        
        // 5. Start the first question of this round
        loadQuestion(0);
    }

    function startBattle() {
        document.getElementById('introScreen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('battleScreen').style.display = 'grid';
            document.getElementById('battleScreen').style.opacity = '1';
            loadRound(0);
            startTimer();
            // Start the passive mana generation loop
            startBossLoop();
        }, 500);
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            // Respect Time Freeze Ability
            if (!window.isTimeFrozen) {
                timeLeft--;
            }
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById('timer').innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
            if(timeLeft <= 0) { clearInterval(timerInterval); alert("MISSION FAILED"); }
        }, 1000);
    }

    function loadQuestion(idx) {
        resetBoardState(); // CLEANUP BEFORE LOADING NEW QUESTION
        
        // CHECK END CONDITIONS
        if(idx >= questions.length) { 
            if(currentHP > 0) failGame(); else winGame(); 
            return; 
        }
        
        const qData = questions[idx];
        const currentPassage = passages.find(p => p.id === qData.tId);
        const textPanel = document.getElementById('textPanel');
        
        // Load Text (Only if different from current)
        if (!textPanel.innerHTML.includes(currentPassage.title)) {
            textPanel.style.opacity = '0';
            setTimeout(() => {
                textPanel.innerHTML = `<h3>${currentPassage.title}</h3>${currentPassage.content}`;
                textPanel.style.opacity = '1';
                // Re-apply tool modes if active
                document.querySelectorAll('.tool-active').forEach(btn => {
                    if(btn.innerText.includes("SUFFIX")) textPanel.classList.add('mode-suffix');
                    if(btn.innerText.includes("X-RAY")) textPanel.classList.add('mode-xray');
                    if(btn.innerText.includes("LOGIC")) textPanel.classList.add('mode-logic');
                });
                updateSuffixVisuals();
            }, 300);
        }

        const qContainer = document.getElementById('quiz-container');
        let optsHTML = "";
        qData.opts.forEach((opt, i) => {
            optsHTML += `<button class="opt-btn" onclick="checkAnswer(this, ${i === qData.ans})">${opt}</button>`;
        });

        qContainer.innerHTML = `
            <div class="q-card">
                <div style="font-size:0.8rem; color:var(--gold); margin-bottom:10px;">QUESTION ${idx + 1} / 20</div>
                <div class="q-text">${qData.q}</div>
                ${optsHTML}
            </div>
        `;
    }

    function checkAnswer(btn, isCorrect) {
        // ============================================
        // 1. SNIPER MODE (PRECISION STRIKE) LOGIC
        // ============================================
        if(isSniperActive) {
            if(!isCorrect) {
                // Wrong Target in Sniper Mode -> Just destroy button
                btn.style.transition = "0.2s";
                btn.style.transform = "scale(0.9)";
                btn.style.backgroundColor = "#EF4444";
                setTimeout(() => {
                    btn.style.visibility = "hidden";
                    btn.style.pointerEvents = "none";
                }, 200);
                try { playSound('gunshot'); } catch(e){}
                return; 
            } else {
                // Correct Target -> Exit Sniper Mode & Continue
                isSniperActive = false;
                document.body.classList.remove('sniper-active');
            }
        }

        // ============================================
        // 2. NORMAL GAMEPLAY LOGIC
        // ============================================
        
        // Lock all buttons immediately
        const allBtns = document.querySelectorAll('.opt-btn');
        allBtns.forEach(b => b.style.pointerEvents = 'none');
        
        const bossEntity = document.getElementById('bossEntity');
        const comboDisplay = document.getElementById('comboDisplay');

        if(isCorrect) {
            // --- WIN PATH ---
            comboStreak++; 
            
            // HERO: CHARGE ENERGY BAR
            processNeuralCharge(); 
            
            // DAMAGE CALCULATION
            let totalDmg = baseDamage + (comboStreak * 2); // Increased Combo Bonus
            currentHP -= totalDmg;
            
            // UPDATE HP BAR (PERCENTAGE CALCULATION)
            let hpPercent = (currentHP / maxHP) * 100;
            document.getElementById('bossHP').style.width = Math.max(0, hpPercent) + "%";
            
            // VISUALS
            btn.classList.add('opt-correct');
            if(comboDisplay) {
                comboDisplay.innerText = `CHAIN x${comboStreak}`;
                comboDisplay.classList.add('combo-active');
            }

            spawnDamageNumber(totalDmg);
            triggerVisualFX('win');
            try { playSound('win'); } catch(e){}

            // BOSS REACTION
            if (hpPercent < 30) bossEntity.classList.add('boss-critical');
            else {
                 bossEntity.classList.add('state-damaged');
                 setTimeout(() => bossEntity.classList.remove('state-damaged'), 1000);
            }

            // GAME OVER OR NEXT QUESTION
            if(currentHP <= 0) {
                setTimeout(winGame, 1000);
            } else {
                // NEXT QUESTION / NEXT ROUND
                setTimeout(() => {
                    if (currentQIndex + 1 < questions.length) {
                        currentQIndex++;
                        loadQuestion(currentQIndex);
                    } else {
                        showRoundTransition(currentRoundIndex + 1);
                    }
                }, 1500);
            }

        } else {
            // --- LOSS PATH (HARDCORE MODE) ---
            comboStreak = 0;
            
            // VISUALS: ONLY Show Red (Do not reveal Green)
            btn.classList.add('opt-wrong');
            
            // [REMOVED] The code that turned the correct answer green is GONE.
            
            // UI UPDATES
            if(comboDisplay) {
                comboDisplay.innerText = "CHAIN BROKEN";
                comboDisplay.classList.remove('combo-active');
            }
            
            // BOSS ATTACK
            addMana(25); 
            showFeedback(false, "MISS! CHARGE LOST");
            bossSpeak("attack");
            bossEntity.classList.add('state-attack');
            setTimeout(() => { bossEntity.classList.remove('state-attack'); }, 1500);
            
            triggerVisualFX('lose');
            try { playSound('lose'); } catch(e){}
            document.body.classList.add('shake-screen');
            setTimeout(() => document.body.classList.remove('shake-screen'), 500);

            // NEXT QUESTION / NEXT ROUND
            setTimeout(() => {
                if (currentQIndex + 1 < questions.length) {
                    currentQIndex++;
                    loadQuestion(currentQIndex);
                } else {
                    showRoundTransition(currentRoundIndex + 1);
                }
            }, 2500);
        }
    }


    // =========================================================================
    // SECTION 5: HERO SYSTEM (ENERGY & SKILLS) - UPDATED
    // =========================================================================

    function processNeuralCharge() {
        // 1. Increment Internal Counter
        chargeProgress++;
        console.log(`>> CHARGE STATUS: ${chargeProgress} / ${CHARGE_REQ}`);

        // 2. Check if we reached the threshold (3 correct answers)
        if(chargeProgress >= CHARGE_REQ) {
            // SUCCESS! Give 1 Bar
            chargeProgress = 0; 
            addFocus(1); 
            showFeedback(true, "ENERGY CELL CHARGED! (+1)");
            try { playSound('charge_complete'); } catch(e){}
        } else {
            // PARTIAL CHARGE (Show percentage)
            const percent = Math.floor((chargeProgress / CHARGE_REQ) * 100);
            showFeedback(true, `CHARGING... ${percent}%`);
        }
    }

    function addFocus(amount) {
        playerFocus += amount;
        if(playerFocus > MAX_FOCUS) playerFocus = MAX_FOCUS;
        if(playerFocus < 0) playerFocus = 0;
        updateFocusUI();
    }

    function updateFocusUI() {
        // 1. Update Blue Pips
        for(let i=1; i<=MAX_FOCUS; i++) {
            const pip = document.getElementById(`focus${i}`);
            if(pip) {
                if(i <= playerFocus) pip.classList.add('active');
                else pip.classList.remove('active');
            }
        }
        
        // 2. Unlock Buttons based on Cost (Tier 1=2, Tier 2=3, Tier 3=5)
        const btn1 = document.getElementById('skillBtn1');
        const btn2 = document.getElementById('skillBtn2');
        const btn3 = document.getElementById('skillBtn3');

        if(btn1 && btn2 && btn3) {
            [btn1, btn2, btn3].forEach(b => {
                 b.classList.remove('ready', 'disabled');
                 b.classList.add('disabled');
            });

            if(playerFocus >= 2) { btn1.classList.remove('disabled'); btn1.classList.add('ready'); }
            if(playerFocus >= 3) { btn2.classList.remove('disabled'); btn2.classList.add('ready'); }
            if(playerFocus >= 4) { btn3.classList.remove('disabled'); btn3.classList.add('ready'); }
        }
    }

    // --- SKILL 1: DOUBLE SLASH (Cost: 2) ---
    function castDoubleSlash() {
        if(playerFocus < 2) return;
        if(isAbilityActive) return; 

        addFocus(-2);
        try { playSound('slash'); } catch(e){}

        const allBtns = Array.from(document.querySelectorAll('.opt-btn'));
        const correctBtn = allBtns.find(b => b.getAttribute('onclick').includes('true'));
        const wrongBtns = allBtns.filter(b => b !== correctBtn && b.style.visibility !== 'hidden');

        // Randomly hide 2
        wrongBtns.sort(() => Math.random() - 0.5);
        let count = 0;
        wrongBtns.forEach(btn => {
            if(count < 2) {
                btn.style.transition = "0.2s";
                btn.style.transform = "scaleX(0)";
                setTimeout(() => btn.style.visibility = "hidden", 200);
                count++;
            }
        });
    }

    
    
    // --- SKILL 2: LOGIC VISUALIZER (UPDATED FOR NEW TEXTS) ---
    function castKeywordExtractor() {
        if(playerFocus < 3) return;

        // MAPS MUST MATCH THE NEW TEXTS EXACTLY
        const logicSummaries = {
            // --- ROUND 1 (B2) ---
            1: [ // Coffee
                { type: "node", text: "Coffee Houses" },
                { type: "arrow", text: "CONSEQUENTLY" },
                { type: "core", text: "Social Mixing" },
                { type: "arrow", text: "HOWEVER" },
                { type: "result", text: "Political Paranoia" }
            ],
            2: [ // Digital Nomads
                { type: "node", text: "Tech Advances" },
                { type: "arrow", text: "ENABLE" },
                { type: "core", text: "Remote Work" },
                { type: "arrow", text: "HOWEVER" },
                { type: "result", text: "Isolation & Loneliness" }
            ],
            3: [ // Bees
                { type: "core", text: "Pollination Role" },
                { type: "arrow", text: "MAKES THEM" },
                { type: "node", text: "Irreplaceable" },
                { type: "arrow", text: "CONVERSELY" },
                { type: "result", text: "Collapse = Disaster" }
            ],
            4: [ // Sara's Letter
                { type: "node", text: "Mall Project" },
                { type: "arrow", text: "IGNORES" },
                { type: "core", text: "Traffic & Environment" },
                { type: "arrow", text: "INSTEAD" },
                { type: "result", text: "Revitalize Local Biz" }
            ],

            // --- ROUND 2 (C1) ---
            5: [ // Paradox of Choice (Re-indexes to 5, 6, 7, 8 if continuing game)
                 // NOTE: Game might reset Q index. Let's assume ID 1-4 for Round 2 as well.
                 // BETTER LOGIC: Check currentRoundIndex in the function below.
            ]
        };
        
        // DYNAMICALLY SELECT BASED ON ROUND
        // If we are in Round 2, we need a different set of logic maps.
        let chainData = [];
        
        // This simple switch handles the IDs based on the active Round
        if (currentRoundIndex === 0) { // ROUND 1
             // Map Q1-4 to the Logic 1-4
             // We use (currentQIndex + 1) to match the ID
             chainData = logicSummaries[currentQIndex + 1];
        } 
        else if (currentRoundIndex === 1) { // ROUND 2
             // Define Round 2 Logic Here
             const r2Logic = {
                1: [{type:"core", text:"Too Many Choices"}, {type:"arrow", text:"CAUSES"}, {type:"node", text:"Paralysis"}, {type:"arrow", text:"THUS"}, {type:"result", text:"Unhappiness"}],
                2: [{type:"node", text:"Fast Fashion"}, {type:"arrow", text:"LEADS TO"}, {type:"core", text:"Disposable Culture"}, {type:"arrow", text:"BUT"}, {type:"result", text:"Unsustainable"}],
                3: [{type:"core", text:"Collisions"}, {type:"arrow", text:"CREATE"}, {type:"node", text:"More Debris"}, {type:"arrow", text:"ULTIMATELY"}, {type:"result", text:"Space Trap"}],
                4: [{type:"node", text:"Historical Data"}, {type:"arrow", text:"CONTAINS"}, {type:"core", text:"Bias"}, {type:"arrow", text:"THEREFORE"}, {type:"result", text:"AI Discriminates"}]
             };
             let textRef = Math.floor(currentQIndex / 5) + 1;
             chainData = r2Logic[currentQIndex + 1];
        }
        else if (currentRoundIndex === 2) { // ROUND 3 (HIGH C1) - NEW!
             const r3Logic = {
                1: [{type:"node", text:"Language"}, {type:"arrow", text:"FRAMES"}, {type:"core", text:"Perception"}, {type:"arrow", text:"THUS"}, {type:"result", text:"Cognitive Bias"}],
                2: [{type:"node", text:"Entanglement"}, {type:"arrow", text:"VIOLATES"}, {type:"core", text:"Locality"}, {type:"arrow", text:"IMPLIES"}, {type:"result", text:"Non-Local Universe"}],
                3: [{type:"core", text:"Self-Interest"}, {type:"arrow", text:"VS"}, {type:"node", text:"Cooperation"}, {type:"arrow", text:"THEREFORE"}, {type:"result", text:"Governance Possible"}],
                4: [{type:"node", text:"Delay"}, {type:"arrow", text:"CAUSES"}, {type:"core", text:"Prejudice"}, {type:"arrow", text:"IMPLIES"}, {type:"result", text:"Loss of Rights"}]
             };
             let textRef = Math.floor(currentQIndex / 5) + 1; 
             chainData = r3Logic[textRef];
        }

        addFocus(-3);
        try { playSound('scan_activate'); } catch(e) {}

        const panel = document.getElementById('textPanel');
        let html = '<div class="chain-container">';
        
        if(chainData) {
            chainData.forEach(item => {
                if(item.type === 'arrow') {
                    html += `<div class="chain-arrow">‚Üì ${item.text} ‚Üì</div>`;
                } else {
                    html += `<div class="chain-node ${item.type}">${item.text}</div>`;
                }
            });
        } else {
             html += '<div class="chain-node">LOGIC DATA UNAVAILABLE</div>';
        }
        
        html += '</div>';
        panel.innerHTML = html;
        showFeedback(true, "LOGIC EXTRACTED");
    }

    // --- SKILL 3: PRECISION STRIKE (Cost: 5) ---
    function castPrecisionStrike() {
        if(playerFocus < 4) return; 

        addFocus(-4);
        try { playSound('sniper_load'); } catch(e){}

        isSniperActive = true;
        document.body.classList.add('sniper-active'); 
        showFeedback(true, "PRECISION STRIKE ACTIVE: ELIMINATE TARGETS");
    }


    // =========================================================================
    // SECTION 6: BOSS AI & MECHANICS
    // =========================================================================

    function startBossLoop() {
        setInterval(() => {
            const failScreen = document.getElementById('failScreen');
            const isFailVisible = window.getComputedStyle(failScreen).display === 'flex'; 
            const isPeeking = document.getElementById('panicOverlay') && document.getElementById('panicOverlay').classList.contains('panic-active');

            if (currentHP > 0 && !isFailVisible && !isPeeking && !isAbilityActive) {
                addMana(MANA_PASSIVE_RATE);
            }
        }, 100); 
    }

    function addMana(amount) {
        if(currentHP <= 0) return;
        if(isAbilityActive) return; 

        bossMana += amount;
        if(bossMana > 100) bossMana = 100;
        
        const bar = document.getElementById('bossManaBar');
        const text = document.getElementById('manaText');
        if(bar) bar.style.width = bossMana + "%";
        if(text) text.innerText = Math.floor(bossMana) + "%";

        if(bossMana >= 100) {
            console.log(">> BOSS CHARGE FULL! Initiating Attack...");
            isAbilityActive = true; 
            bossMana = 0;
            if(bar) bar.style.width = "0%";
            if(text) text.innerText = "0%";

            try { triggerBossSkill(); } catch(e) {
                console.error(e);
                finishBossAttack(); 
            }
        }
    }

    const bossLines = {
        idle: ["Waktu berjalan...", "Kerjakan sendiri.", "Mata ke monitor.", "Jangan berisik."],
        hit: ["Mustahil!", "Kok bisa tahu?!", "Hoki doang itu!", "Siapa gurumu?!", "Tunggu soal berikutnya!"],
        attack: ["SALAH!", "Minus poin!", "Kamu tidak belajar?!", "Saya catat nomor kamu!", "Gagal total!"]
    };

    function bossSpeak(type) {
        const bubble = document.getElementById('bossBubble');
        if(!bubble) return;
        const lines = bossLines[type] || bossLines['idle'];
        const randomLine = lines[Math.floor(Math.random() * lines.length)];
        
        bubble.innerText = randomLine;
        bubble.classList.add('bubble-show');
        setTimeout(() => { bubble.classList.remove('bubble-show'); }, 2000);
    }
    
    function bossSpeakAttack(text) {
        const bubble = document.getElementById('bossBubble');
        bubble.innerText = text;
        bubble.style.color = "var(--red)";
        bubble.classList.add('bubble-show');
        setTimeout(() => {
            bubble.classList.remove('bubble-show');
            bubble.style.color = "black";
        }, 2000);
        
        const boss = document.getElementById('bossEntity');
        boss.classList.add('state-attack');
        setTimeout(() => boss.classList.remove('state-attack'), 1000);
    }

    function triggerBossSkill() {
        if (currentHP <= 0 || document.getElementById('failScreen').style.display === 'flex') {
            isAbilityActive = false; return;
        }

        let skillName = "";
        if (bossSkillCycle === 0) { skillName = "VOCABULARY CHECK"; skillLexicalOverload(); } 
        else if (bossSkillCycle === 1) { skillName = "SILENCE (LOCK)"; skillSilence(); } 
        else if (bossSkillCycle === 2) { skillName = "SYSTEM GLITCH"; skillGlitch(); }

        showSkillAnnouncement(skillName);

        bossSkillCycle++; 
        if (bossSkillCycle > 2) bossSkillCycle = 0;

        // Watchdog
        setTimeout(() => {
            if(isAbilityActive) {
                console.warn(">> WATCHDOG: Force-unlocking mana bar.");
                isAbilityActive = false;
            }
        }, 12000); 
    }

    function showSkillAnnouncement(name) {
        let announce = document.getElementById('skillAnnounce');
        if (!announce) {
            announce = document.createElement('div');
            announce.id = 'skillAnnounce';
            announce.style.cssText = 'position:fixed; top:20%; left:50%; transform:translate(-50%, -50%); background:rgba(255,0,0,0.8); color:white; padding:10px 30px; font-family:monospace; font-weight:bold; z-index:1000; pointer-events:none; border:2px solid white; display:none;';
            document.body.appendChild(announce);
        }
        announce.innerText = "BOSS CASTING: " + name;
        announce.style.display = 'block';
        setTimeout(() => { announce.style.display = 'none'; }, 2000);
    }

    // --- BOSS ABILITY 1: VOCABULARY OVERLOAD ---
    function skillLexicalOverload() {
        console.log(">> SKILL: Lexical Overload");
        bossSpeakAttack("VOCABULARY CHECK!");
        
        // TRIGGER NEW SOUND
        playSound('boss_magic'); 

        const localMatrix = {
            "common": ["ubiquitous", "prevalent"], "rare": ["scarce", "infrequent"],
            "life": ["existence", "sentience"], "humans": ["homo sapiens", "populace"],
            "exist": ["persist", "endure"], "filter": ["sift", "winnow"],
            "idea": ["concept", "paradigm"], "view": ["perspective", "standpoint"],
            "change": ["fluctuate", "metamorphose"], "evidence": ["corroboration", "substantiation"],
            "difficult": ["arduous", "laborious"], "likely": ["plausible", "presumable"],
            "is": ["constitutes", "represents"], "are": ["embody", "constitute"],
            "many": ["multitudinous", "myriad"]
        };

        const panel = document.getElementById('textPanel');
        const walker = document.createTreeWalker(panel, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const targetableNodes = [];

        while(node = walker.nextNode()) {
            const text = node.nodeValue;
            if(text.trim().length > 2) {
                 const hasKeyword = Object.keys(localMatrix).some(key => new RegExp(`\\b${key}\\b`, 'i').test(text));
                const parentClass = node.parentNode.className || "";
                if(hasKeyword && !parentClass.includes("cursed-word")) targetableNodes.push(node);
            }
        }

        if(targetableNodes.length === 0) { finishBossAttack(); return; }

        const attackCount = Math.min(5, targetableNodes.length);
        for(let i=0; i<attackCount; i++) {
            const targetNode = targetableNodes[Math.floor(Math.random() * targetableNodes.length)];
            const text = targetNode.nodeValue;
            const foundKey = Object.keys(localMatrix).find(key => new RegExp(`\\b${key}\\b`, 'i').test(text));

            if(foundKey) {
                const replacements = localMatrix[foundKey];
                const advancedWord = replacements[Math.floor(Math.random() * replacements.length)];
                const match = text.match(new RegExp(`\\b${foundKey}\\b`, 'i'));
                if(!match) continue;
                const originalWordExact = match[0];

                const span = document.createElement('span');
                span.className = "cursed-word";
                span.innerText = advancedWord.toUpperCase();
                span.dataset.original = originalWordExact;
                span.dataset.cursed = advancedWord.toUpperCase();
                span.dataset.state = "closed"; 
                span.setAttribute("onclick", "togglePeek(this)"); 
                span.style.userSelect = "none"; 
                span.style.cursor = "pointer";

                const wrapper = document.createElement('span');
                const safeKey = foundKey.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const parts = text.split(new RegExp(`\\b${safeKey}\\b`, 'i'));

                if(parts.length > 1) {
                    wrapper.innerHTML = parts[0];
                    wrapper.appendChild(span);
                    wrapper.append(parts.slice(1).join(originalWordExact));
                    targetNode.parentNode.replaceChild(wrapper, targetNode);
                }
            }
        }
        activeBossTimer = setTimeout(finishBossAttack, 10000); 
    }

    // --- BOSS ABILITY 2: SILENCE ---
    function skillSilence() {
        // TRIGGER NEW SOUND
        playSound('boss_lock'); 

        bossSpeakAttack("DIAM!");
        const btns = document.querySelectorAll('.opt-btn');
        if(btns.length > 0) {
            btns.forEach(btn => {
                btn.classList.add('opt-locked');
                btn.style.pointerEvents = 'none';
            });
            activeBossTimer = setTimeout(finishBossAttack, 10000); 
        } else {
            finishBossAttack();
        }
    }

    // --- BOSS ABILITY 3: GLITCH ---
    function skillGlitch() {
        // TRIGGER NEW SOUND
        playSound('boss_glitch'); 

        bossSpeakAttack("SYSTEM ERROR...");
        const qText = document.querySelector('.q-text');
        if(!qText) { finishBossAttack(); return; }

        const originalText = qText.innerText;
        qText.classList.add('text-glitched');
        qText.innerText = originalText.split('').sort(() => 0.5 - Math.random()).join('');

        activeBossTimer = setTimeout(() => {
            qText.innerText = originalText; 
            finishBossAttack();
        }, 5000);
    }


    // =========================================================================
    // SECTION 7: STATE MANAGEMENT & CLEANUP
    // =========================================================================

    function finishBossAttack() {
        console.log(">> ATTACK ENDED: Resuming Mana Generation & Cleaning Up");
        isAbilityActive = false;
        
        // Clean Words
        const cursed = document.querySelectorAll('.cursed-word');
        cursed.forEach(span => {
            if(span.dataset.original) {
                if(span.dataset.state === "open" && window.togglePeek) window.togglePeek(span); 
                const text = document.createTextNode(span.dataset.original);
                span.parentNode.replaceChild(text, span);
            }
        });

        // Clean Buttons
        const btns = document.querySelectorAll('.opt-btn');
        btns.forEach(btn => {
            btn.classList.remove('opt-locked');
            btn.style.pointerEvents = 'auto';
        });

        // Clean Glitch
        const qText = document.querySelector('.q-text');
        if(qText) qText.classList.remove('text-glitched');

        try { playTone(600, 'sine', 0.5, 0.1); } catch(e){}
    }

    function resetBoardState() {
        console.log(">> SYSTEM: Cleaning Board.");
        isAbilityActive = false;
        
        // 1. DISABLE SNIPER MODE
        isSniperActive = false;
        document.body.classList.remove('sniper-active');
        
        // 2. DISABLE LOGIC VISUALIZER (The new update)
        const panel = document.getElementById('textPanel');
        if(panel) panel.classList.remove('logic-mode');

        // 3. KILL BOSS TIMERS
        if (activeBossTimer) { clearTimeout(activeBossTimer); activeBossTimer = null; }

        // 4. RESET BUTTONS
        const btns = document.querySelectorAll('.opt-btn');
        btns.forEach(btn => {
            btn.classList.remove('opt-locked');
            btn.style.pointerEvents = 'auto';
            btn.style.visibility = 'visible';
            btn.style.transform = 'none';
        });

        // 5. RESET GLITCH & CURSES
        const qText = document.querySelector('.q-text');
        if(qText) qText.classList.remove('text-glitched');

        const cursed = document.querySelectorAll('.cursed-word');
        cursed.forEach(span => {
            if(span.dataset.original) {
                const text = document.createTextNode(span.dataset.original);
                span.parentNode.replaceChild(text, span);
            }
        });

        // 6. RESET VISUAL OVERLAYS
        const panic = document.getElementById('panicOverlay');
        if(panic) panic.classList.remove('panic-active');
        document.body.classList.remove('shake-screen');
        if(typeof peekInterval !== 'undefined') clearInterval(peekInterval);
        
        const timerEl = document.getElementById('timer');
        if(timerEl) timerEl.style.color = "#EF4444";
    }
    
    // Toggle for the Cursed Words (Global)
    window.togglePeek = function(span) {
        if (span.dataset.state === "closed") {
            span.dataset.state = "open";
            span.innerText = span.dataset.original; 
            span.style.color = "#FFFFFF"; 
            span.style.backgroundColor = "#DC2626";
            span.style.padding = "0 4px";
            span.style.borderRadius = "4px";
            const panic = document.getElementById('panicOverlay');
            if(panic) panic.classList.add('panic-active');
            
            if(peekInterval) clearInterval(peekInterval);
            peekInterval = setInterval(() => {
                if(typeof timeLeft !== 'undefined') {
                    timeLeft--; 
                    try { playTone(800, 'square', 0.05, 0.05); } catch(e){}
                    let m = Math.floor(timeLeft / 60);
                    let s = timeLeft % 60;
                    document.getElementById('timer').innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
                    if(timeLeft <= 0) { clearInterval(peekInterval); failGame(); }
                }
            }, 200); 
        } else {
            span.dataset.state = "closed";
            span.innerText = span.dataset.cursed; 
            span.style.color = "#C084FC"; 
            span.style.backgroundColor = "transparent";
            span.style.padding = "0";
            const panic = document.getElementById('panicOverlay');
            if(panic) panic.classList.remove('panic-active');
            if(peekInterval) clearInterval(peekInterval);
        }
    }

    function toggleTool(btn, modeClass) {
        const panel = document.getElementById('textPanel');

        if(btn.innerText.includes("ADJECTIVE") || modeClass === 'mode-suffix') {
            modeClass = 'mode-adj'; 
        }
        
        // 1. Toggle the class (Turn it on or off)
        // This line adds/removes 'mode-suffix', 'mode-xray', etc.
        const isActive = panel.classList.toggle(modeClass);
        
        // 2. Visual Feedback on the Button itself
        if (isActive) {
            btn.classList.add('tool-active');
        } else {
            btn.classList.remove('tool-active');
        }

        // 3. Play Sound based on the tool
        if (isActive) {
            if (modeClass === 'mode-suffix') try { playSound('tool_cut'); } catch(e){}
            if (modeClass === 'mode-xray') try { playSound('tool_scan'); } catch(e){}
            if (modeClass === 'mode-logic') { 
                try { playSound('tool_logic'); } catch(e){}
                // Special case for Logic: it needs to run its own extractor
                castKeywordExtractor(); 
            }
        }

        // 4. CRITICAL UPDATE: Refresh the text to show/hide hyphens
        updateSuffixVisuals();
    }

    function winGame() {
        clearInterval(timerInterval);
        try{ confetti({ particleCount: 300, spread: 120 }); } catch(e){}
        document.getElementById('winScreen').style.display = 'flex';
        playSound('win');
    }

    function failGame() {
        clearInterval(timerInterval);
        document.getElementById('failScreen').style.display = 'flex';
        playSound('lose');
    }

    // --- TRANSITION LOGIC ---
    let pendingRoundIndex = 0; // Stores which round we are about to start

    function showRoundTransition(nextRoundIdx) {
        pendingRoundIndex = nextRoundIdx;
        
        // 1. Get Elements
        const screen = document.getElementById('transitionScreen');
        const title = document.getElementById('transTitle');
        const levelName = document.getElementById('nextLevelName');
        const desc = document.getElementById('transDesc');

        // 2. Customize Text based on the coming round
        if (nextRoundIdx === 1) {
            // Going to Round 2
            title.innerText = "SECTOR 1 CLEARED";
            desc.innerText = "Standard English tests passed. Initializing Advanced Protocols.";
            levelName.innerText = "LEVEL 2: ADVANCED (C1)";
            levelName.style.color = "#3B82F6"; // Blue
        } 
        else if (nextRoundIdx === 2) {
            // Going to Round 3
            title.innerText = "SECTOR 2 CLEARED";
            desc.innerText = "Warning: High-Level Scholastic Logic detected.";
            levelName.innerText = "LEVEL 3: SCHOLASTIC (BOSS)";
            levelName.style.color = "#EF4444"; // Red
        }

        // 3. Show Screen
        screen.style.display = 'flex';
        
        // Optional: Play a sound
        try { playSound('scan_activate'); } catch(e){}
    }

    function continueToNextRound() {
        // Hide transition screen
        document.getElementById('transitionScreen').style.display = 'none';
        // Actually load the round
        loadRound(pendingRoundIndex);
    }

</script>

</body>
</html>