<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modul 4: The Final Boss (20 Rounds)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Plus+Jakarta+Sans:wght@400;600;800&family=Lora:ital,wght@0,600;1,500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #020617; 
            --panel: #0F172A;
            --border: #1E293B;
            --text-main: #E2E8F0;
            --text-muted: #94A3B8;
            --gold: #F59E0B;
            --gold-glow: rgba(245, 158, 11, 0.4);
            --red: #EF4444;
            --green: #10B981;
            --font-tech: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
        }

        /* ================= FX LAYERS ================= */
        .fx-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 90; opacity: 0; transition: opacity 0.1s;
        }
        #damageOverlay {
            background: radial-gradient(circle, transparent 50%, rgba(239, 68, 68, 0.6) 100%);
            box-shadow: inset 0 0 100px rgba(239, 68, 68, 0.8);
        }
        #healOverlay {
            background: radial-gradient(circle, transparent 50%, rgba(16, 185, 129, 0.4) 100%);
            box-shadow: inset 0 0 100px rgba(16, 185, 129, 0.6);
        }
        .trigger-damage { animation: flashRed 0.5s ease-out; }
        .trigger-heal { animation: flashGreen 0.5s ease-out; }

        @keyframes flashRed { 0% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0; transform: scale(1); } }
        @keyframes flashGreen { 0% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0; transform: scale(1); } }

        /* ================= INTRO ================= */
        .screen-intro {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%);
            z-index: 100; transition: opacity 0.5s;
        }
        .intro-title {
            font-size: 4rem; font-weight: 800; text-transform: uppercase; margin: 0;
            background: linear-gradient(to bottom, #FFF, #94A3B8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .start-btn {
            margin-top: 40px; background: var(--gold); color: black; border: none;
            padding: 20px 50px; font-size: 1.2rem; font-weight: 800; font-family: var(--font-tech);
            cursor: pointer; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: 0.2s; box-shadow: 0 0 30px var(--gold-glow);
        }
        .start-btn:hover { transform: scale(1.05); background: #fff; }

        /* ================= BATTLE HUD ================= */
        .screen-battle {
            display: none; 
            grid-template-rows: 80px 1fr 60px; 
            height: 100vh; 
            width: 100%;
            overflow: hidden;
            opacity: 0; 
            transition: opacity 1s;
        }

        /* TOP BAR */
        .hud-top {
            background: #020617; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
        }
        .boss-hp-container {
            width: 300px; height: 10px; background: #334155; border-radius: 5px; overflow: hidden; position: relative;
        }
        .boss-hp-bar {
            width: 100%; height: 100%; background: var(--gold); transition: width 0.5s; box-shadow: 0 0 10px var(--gold);
        }
        .timer { font-family: var(--font-tech); font-size: 1.5rem; font-weight: bold; color: #EF4444; }

        /* ================= ARENA LAYOUT (3 COLUMNS) ================= */
        .battle-arena {
            display: grid;
            /* 180px for Boss | Flexible Text | Fixed Quiz */
            grid-template-columns: 180px 1fr 0.8fr; 
            height: 100%;
            overflow: hidden;
        }
        /* ================= MOBILE FIXED (ABSOLUTE POSITIONING) ================= */
@media (max-width: 900px) {

    /* 1. MAIN LAYOUT */
    .battle-arena {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 60px); 
        overflow: hidden; 
    }

    /* 2. THE HEADER STRIP */
    .boss-sidebar {
        height: 120px; /* Increased slightly to fit his head */
        min-height: 120px;
        width: 100%;
        background: #0f172a; 
        border-bottom: 3px solid var(--gold);
        
        /* CRITICAL: Allows us to pin the boss inside */
        position: relative; 
        display: block; /* Stop using Flexbox for the container */
        overflow: hidden; /* Cut off his legs, keep the body */
    }

    /* 3. THE BOSS (PINNED TO BOTTOM) */
    .boss-frame {
        position: absolute;
        bottom: 0; /* Sit on the floor of the header */
        left: 50%; /* Center horizontally */
        transform: translateX(-50%); /* Center alignment correction */
        
        width: 160px; /* Give him a fixed width container */
        height: 100%; 
        z-index: 10; /* Ensure he is above the background */
        
        /* Remove old flex properties that might conflict */
        display: block; 
        margin: 0;
    }

    .boss-scaler {
        /* Force him to be anchored to the bottom center */
        transform-origin: bottom center !important; 
        transform: scale(0.38) !important; /* Scale him down */
        
        /* Positioning inside the frame */
        position: absolute;
        bottom: -15px; /* Push him down slightly so we see chest-up */
        left: 0;
        right: 0;
        margin: 0 auto;
    }

    /* 4. CHAT BUBBLE (TOP RIGHT) */
    .boss-bubble {
        left: auto !important;
        right: 10px !important; /* Stick to right edge */
        top: 10px !important;
        width: 140px !important;
        transform-origin: top right;
        z-index: 20;
    }
    .boss-bubble::after {
        left: auto; right: 20px; /* Tail points right */
        bottom: -10px; top: auto;
        border-width: 10px 10px 0; /* Triangle pointing down */
        border-color: white transparent transparent transparent;
    }

    /* 5. TEXT PANEL (SCROLLABLE) */
    .text-panel {
        flex: 1; 
        overflow-y: auto; 
        padding: 20px;
        background: var(--bg);
        font-size: 1rem;
        border-bottom: 1px solid var(--border);
    }

    /* 6. CONTROL PANEL (BOTTOM) */
    .control-panel {
        height: 35%;
        min-height: 220px;
        overflow-y: auto;
        padding: 10px;
        background: #1e293b;
    }

    /* HIDE the "PENGAWAS" label */
    .boss-sidebar div[style*="font-size:0.7rem"] { display: none; }
}

        /* ================= BOSS SIDEBAR ================= */
        .boss-sidebar {
            background: #020617; /* Very Dark */
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding-top: 100px;
            align-items: center;
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 20px;
            box-shadow: inset -10px 0 20px rgba(0,0,0,0.5); /* Shadow for depth */
        }

        /* ================= BOSS SPRITE (SIDEBAR MODE) ================= */
        .boss-frame {
            width: 100%;
            height: 300px; /* Tall enough for him */
            display: flex; 
            justify-content: center; 
            align-items: center;
            overflow: visible; 
            position: relative;
        }

        .boss-scaler {
            /* 1. MATH: 619px / 4 = 154.75px */
            width: 154.75px; 
            height: 337px;
            
            /* 2. SCALE: 0.6 fits perfectly in the 180px sidebar */
            transform: scale(1.0); 
            transform-origin: center center;
        }
        
        #bossEntity {
            width: 154.75px; 
            height: 337px;
            background-image: url("image/boss_idle.png"); 
            background-size: 619px 337px; 
            background-repeat: no-repeat;
            animation: play-sprite 1s steps(4) infinite;
            image-rendering: pixelated; 
        }

        /* --- STATES (Same as before) --- */
        @keyframes play-sprite {
            from { background-position: 0px 0px; }
            to { background-position: -619px 0px; } 
        }

        #bossEntity.state-damaged {
            background-image: url("image/boss_shock.png") !important;
            animation: play-sprite 0.5s steps(4) infinite;
            filter: sepia(100%) hue-rotate(-50deg) saturate(600%) brightness(0.8);
        }

        #bossEntity.state-attack {
            background-image: url("image/boss_angry.png") !important;
            animation: play-sprite 0.8s steps(4) infinite;
            filter: brightness(1.5) contrast(1.2);
        }

        /* TEXT PANEL */
        .text-panel {
            padding: 40px; overflow-y: auto; border-right: 1px solid var(--border);
            background: #0B101E; position: relative; transition: opacity 0.3s;
        }
        .passage { font-family: 'Lora', serif; font-size: 1.15rem; line-height: 1.8; color: #CBD5E1; max-width: 700px; margin: 0 auto; }
        .passage h3 { color: var(--gold); border-bottom: 1px solid #334155; padding-bottom: 10px; margin-top: 0; }

        /* TEXT FORMATS */
        .academic-text { font-family: 'Lora', serif; color: #CBD5E1; }
        .transcript-box { font-family: 'Plus Jakarta Sans', sans-serif; display: flex; flex-direction: column; gap: 15px; }
        .speech-bubble { background: #1E293B; padding: 15px; border-radius: 0 12px 12px 12px; border-left: 3px solid var(--gold); }
        .host { border-left-color: #34D399; }
        .speaker { display: block; font-size: 0.75rem; font-weight: 800; color: var(--gold); margin-bottom: 5px; }
        .host .speaker { color: #34D399; }

        .news-wrapper { background: #E2E8F0; color: #0F172A; padding: 30px; border-radius: 4px; }
        .news-headline { font-family: 'Times New Roman', serif; font-weight: 900; font-size: 2rem; line-height: 1; margin: 0 0 10px 0; }
        .news-meta { font-size: 0.8rem; font-weight: bold; color: #475569; border-bottom: 2px solid #0F172A; margin-bottom: 20px; padding-bottom: 10px; }
        .news-body { font-family: 'Georgia', serif; font-size: 1.1rem; line-height: 1.6; text-align: justify; }
        .news-wrapper .core { background: rgba(245, 158, 11, 0.3); color: black; }

        .log-wrapper { font-family: 'JetBrains Mono', monospace; color: #34D399; }
        .log-header { border-bottom: 1px dashed #34D399; padding-bottom: 10px; margin-bottom: 20px; opacity: 0.7; font-size: 0.8rem; }
        .log-entry::before { content: "> "; color: var(--gold); }

        /* TOOLS CSS */
        .mode-suffix .junk { opacity: 0.2; text-decoration: line-through; text-decoration-color: var(--red); transition: 0.3s; }
        .mode-xray .core { color: var(--gold); font-weight: 800; background: rgba(245, 158, 11, 0.15); padding: 0 4px; border-radius: 4px; transition: 0.3s; }
        .mode-logic .connector { border: 1px solid var(--green); color: var(--green); padding: 2px 6px; border-radius: 4px; font-weight: 800; background: rgba(16, 185, 129, 0.1); transition: 0.3s; }

        /* QUIZ PANEL */
        .control-panel { justify-content: flex-start !important; overflow-y: auto !important; padding: 20px 20px 20px 20px; background: #0F172A; display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; z-index: 1; }
        .q-card { background: #1E293B; border: 1px solid #334155; padding: 25px; border-radius: 12px; animation: slideIn 0.4s ease; margin-bottom: 0px; flex-shrink: 0;}
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .opt-btn {
            display: block; width: 100%; padding: 15px; margin-bottom: 10px;
            background: #0F172A; border: 1px solid #334155; color: #CBD5E1; text-align: left;
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .opt-btn:hover { border-color: var(--gold); color: white; background: #182030; }
        .opt-correct { background: #064E3B !important; border-color: #10B981 !important; color: white !important; }
        .opt-wrong { background: #450a0a !important; border-color: #EF4444 !important; opacity: 0.5; }

        /* HUD BOTTOM */
        .hud-bottom { 
            background: #020617; 
            border-top: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 20px;
            
        }
        .tool-btn {
            background: transparent; border: 1px solid #334155; color: #64748B;
            padding: 6px 12px; border-radius: 50px; font-family: var(--font-tech); font-size: 0.75rem;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .tool-btn:hover { border-color: var(--text-main); color: white; }
        .tool-active { border-color: var(--green); color: var(--green); background: rgba(16, 185, 129, 0.1); box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }

        /* MODALS */
        .feedback-modal {
            position: absolute; bottom: 100px; right: 30px; width: 350px;
            background: rgba(0,0,0,0.9); border: 1px solid var(--border); border-left: 4px solid var(--gold);
            padding: 20px; border-radius: 8px; color: white; display: none; backdrop-filter: blur(5px); z-index: 50;
        }
        .screen-win {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; justify-content: center; align-items: center;
        }
        .shake-screen { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(0,0); } 20% { transform: translate(-10px, 0); } 40% { transform: translate(10px, 0); } 100% { transform: translate(0,0); } }

        /* 1. BOSS CRITICAL STATE (HP < 30%) */
        #bossEntity.boss-critical {
            /* REPLACE 'boss_tantrum.png' WITH YOUR ACTUAL FILENAME */
            background-image: url("image/boss_tantrum.png") !important; 
            
            /* Make the animation FASTER (0.5s) to show panic/rage */
            animation: play-sprite 0.5s steps(4) infinite !important;
            
            /* Optional: Add a red shake effect on top of the sprite */
            animation-name: play-sprite, shake-constant !important;
            
            /* Remove the old color filters so we see your actual pixel art colors */
            filter: none !important; 
        }

        /* ================= COMBO & ENDINGS ================= */
        .combo-active { opacity: 1 !important; text-shadow: 0 0 10px var(--green); font-weight: 800; transform: scale(1.1); }
        
        /* Screen for Failing (Boss Alive) */
        .screen-fail {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50, 0, 0, 0.95); z-index: 200; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .fail-title { font-size: 4rem; color: var(--red); margin: 0; text-transform: uppercase; letter-spacing: 5px; }
        .fail-desc { color: #FECACA; font-size: 1.2rem; max-width: 600px; text-align: center; margin-top: 20px; line-height: 1.6; }
    
        /* ================= FAIL SCREEN ================= */
        .screen-fail {
            display: none; /* Hidden by default */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 0, 0, 0.98); /* Dark Red Background */
            z-index: 200; 
            flex-direction: column; justify-content: center; align-items: center;
        }
        
        .fail-title { 
            font-size: 4rem; font-weight: 800; color: var(--red); 
            margin: 0; text-transform: uppercase; letter-spacing: 5px; 
            text-shadow: 0 0 20px var(--red);
        }
        
        .fail-desc { 
            color: #FECACA; font-size: 1.5rem; max-width: 600px; 
            text-align: center; margin-top: 20px; line-height: 1.6; 
        }

        /* ================= RPG FEEDBACK EFFECTS ================= */
        
        /* 1. FLOATING DAMAGE NUMBERS */
        .damage-number {
            position: absolute;
            color: #FFD700; /* Gold */
            font-family: 'Impact', sans-serif;
            font-size: 2rem;
            font-weight: bold;
            pointer-events: none;
            z-index: 100;
            text-shadow: 2px 2px 0px #000;
            animation: floatUp 1s ease-out forwards;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-30px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-60px) scale(1); opacity: 0; }
        }

        /* 2. BOSS SPEECH BUBBLE */
        .boss-bubble {
            position: absolute;
            top: 10px; /* Near his head */
            left: 50%; /* To the right of the sidebar */
            transform: translateX(-50%) scale(0);
            background: white;
            color: black;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: var(--font-tech);
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            width: 90%;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        /* The little triangle pointing to him */
        .boss-bubble::after {
            content: "";
            position: absolute; bottom: -10px; left: 50%;
            transform: translateX(-50%);
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
        
        .bubble-show { 
            transform: translateX(-50%) scale(1) !important
         }
        
        @keyframes popIn { from{transform: scale(0);} to{transform: scale(1);} }

        /* ================= MOBILE RESPONSIVENESS (PHONES) ================= */
        @media (max-width: 900px) {

        /* 1. CHANGE GRID TO VERTICAL STACK */
        .battle-arena {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px); /* Fill screen minus Top HUD */
            overflow: hidden; /* Stop the whole page from scrolling */
            }

        /* 2. SHRINK BOSS TO A "MINI-HEADER" */
        .boss-sidebar {
            height: 90px; /* Fixed small height */
            min-height: 90px;
            width: 100%;
            flex-direction: row; /* Layout items horizontally */
            padding: 0 10px;
            border-right: none;
            border-bottom: 2px solid var(--gold);
            background: #020617;
            overflow: hidden;
            }

        /* 3. MAKE BOSS TINY */
        .boss-frame {
            width: 80px; /* Constrain width */
            height: 100%;
            margin: 0;
            }
    
        .boss-scaler {
            /* Shrink him drastically for mobile */
            transform: scale(0.35) !important; 
            transform-origin: bottom left; /* Anchor him to the bottom-left corner */
            margin-left: 10px;
            }

        /* Hide the "PENGAWAS" label on mobile to save space */
        .boss-sidebar div[style*="font-size:0.7rem"] {
            display: none;
            }
    
        /* Move Chat Bubble to right side on mobile */
        .boss-bubble {
            left: 120px !important;
            top: 20px !important;
            width: 150px !important;
            transform: scale(0);
            transform-origin: left center;
            }
        .boss-bubble::after {
            left: -10px; bottom: auto; top: 10px; /* Point left towards boss */
            border-width: 10px 10px 10px 0;
            border-color: transparent white transparent transparent;
            }

        /* 4. TEXT PANEL (SCROLLABLE TOP HALF) */
        .text-panel {
            flex: 1; /* Take 50% of remaining space */
            height: auto;
            overflow-y: auto; /* Enable scrolling inside this box */
            border-right: none;
            border-bottom: 1px solid var(--border);
            padding: 15px;
            font-size: 0.95rem; /* Slightly smaller text for reading */
            }

        /* 5. QUIZ PANEL (SCROLLABLE BOTTOM HALF) */
        .control-panel {
            flex: 1; /* Take other 50% */
            height: auto;
            overflow-y: auto; /* Enable scrolling for answers */
            padding: 10px;
            background: #0f172a;
            }

        /* Fix Buttons for Touch Screens */
        .opt-btn {
            padding: 12px 10px;
            min-height: 50px; /* Easier to tap */
            font-size: 0.9rem;
            }
    
        .q-card {
            margin-bottom: 50px; /* Extra space at bottom for scrolling */
            }
        }/* ================= BOSS SKILLS FX ================= */

/* SKILL 1: INK SPLATTER */
    .ink-blob {
    position: absolute;
    background: #000;
    border-radius: 50%;
    filter: blur(2px);
    z-index: 50;
    cursor: pointer;
    /* Look like irregular ink */
    box-shadow: 0 0 10px rgba(0,0,0,0.8);
    animation: splat 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
/* Add a shine to make it look wet */
.ink-blob::after {
    content: '';
    position: absolute;
    top: 20%; left: 20%;
    width: 20%; height: 20%;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
}
@keyframes splat { from { transform: scale(0); } to { transform: scale(1); } }
.ink-cleaned { animation: fadeOut 0.3s forwards; }
@keyframes fadeOut { to { opacity: 0; transform: scale(1.5); } }

/* SKILL 2: SILENCE (LOCKED BUTTONS) */
.opt-locked {
    background: #334155 !important;
    color: #64748B !important;
    border-color: #475569 !important;
    cursor: not-allowed !important;
    position: relative;
    overflow: hidden;
}
/* Chains icon overlay */
.opt-locked::after {
    content: "üîí LOCKED";
    position: absolute;
    top: 50%; right: 20px;
    transform: translateY(-50%);
    font-family: var(--font-tech);
    color: #94A3B8;
    font-size: 0.8rem;
    letter-spacing: 2px;
}

/* SKILL 3: GLITCH TEXT */
.text-glitched {
    animation: glitch-anim 0.3s infinite;
    color: var(--red) !important;
    text-shadow: 2px 0 blue, -2px 0 red;
}
@keyframes glitch-anim {
    0% { transform: translate(0) }
    20% { transform: translate(-2px, 2px) }
    40% { transform: translate(-2px, -2px) }
    60% { transform: translate(2px, 2px) }
    80% { transform: translate(2px, -2px) }
    100% { transform: translate(0) }
}

.cursed-word {
    color: #C084FC;
    font-family: 'Times New Roman', serif;
    font-weight: bold;
    border-bottom: 1px dashed #C084FC;
    cursor: help;
    
    /* CRITICAL FIXES */
    user-select: none;           /* Allow clicking, not highlighting */
    -webkit-user-select: none;
    pointer-events: auto !important; /* Force it to accept clicks */
    position: relative;          /* Lift it up */
    z-index: 100;                /* Ensure it's above overlays */
    display: inline-block;
}

@keyframes pulseText {
    0% { text-shadow: 0 0 2px #C084FC; }
    50% { text-shadow: 0 0 8px #C084FC; }
    100% { text-shadow: 0 0 2px #C084FC; }
}

/* PANIC OVERLAY (When peeking at words) */
.panic-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: radial-gradient(circle, transparent 20%, rgba(220, 38, 38, 0.6) 90%);
    z-index: 50;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    mix-blend-mode: multiply;
}
.panic-active { opacity: 1; animation: pulseRed 0.5s infinite; }

@keyframes pulseRed {
    0% { background: radial-gradient(circle, transparent 20%, rgba(220, 38, 38, 0.6) 90%); }
    50% { background: radial-gradient(circle, transparent 15%, rgba(220, 38, 38, 0.8) 90%); }
    100% { background: radial-gradient(circle, transparent 20%, rgba(220, 38, 38, 0.6) 90%); }
}   

    /* HERO UI */
    .focus-pip {
        width: 30px; height: 10px;
        background: #1e293b; 
        border: 1px solid #475569;
        transform: skewX(-20deg);
        transition: 0.3s;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
    }
    .focus-pip.active {
        background: #0EA5E9; /* Cyan Glow */
        border-color: #7DD3FC;
        box-shadow: 0 0 10px #0EA5E9, inset 0 0 5px white;
    }

    .skill-btn {
        flex: 1;
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 4px;
        color: #94a3b8;
        cursor: not-allowed;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        transition: 0.2s;
    }
    .skill-icon { font-size: 1.2rem; filter: grayscale(1); }
    
    /* UNLOCKED STATE */
    .skill-btn.ready {
        background: linear-gradient(to bottom, #1e293b, #0f172a);
        border-color: #38BDF8;
        color: white;
        cursor: pointer;
        box-shadow: 0 2px 0 #0f172a;
    }
    .skill-btn.ready:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(56, 189, 248, 0.3); }
    .skill-btn.ready:active { transform: translateY(0); }
    .skill-btn.ready .skill-icon { filter: grayscale(0); }

    /* Button Colors */
    .skill-btn.ready:nth-child(1) { border-bottom: 2px solid #22c55e; } /* Green */
    .skill-btn.ready:nth-child(2) { border-bottom: 2px solid #eab308; } /* Gold */
    .skill-btn.ready:nth-child(3) { border-bottom: 2px solid #f43f5e; } /* Red */

    /* KEYWORD EXTRACTOR STYLES */
    .word-dimmed {
        opacity: 0.2; /* Fade out fluff words */
        font-weight: normal;
    }
    .word-highlight {
        color: #fff;
        font-weight: bold;
        text-shadow: 0 0 5px #38BDF8; /* Neon Blue Glow */
    }

    /* SNIPER MODE STYLES */
    body.sniper-active .opt-btn {
        cursor: crosshair !important; /* Turn cursor to crosshair */
    }
    body.sniper-active .opt-btn:hover {
        background: #ef4444 !important; /* Turn red on hover */
        color: white;
        border-color: red;
    }
    /* LOGIC CHAIN MODE */
    .logic-mode .word-dimmed {
        opacity: 0.1; /* Almost invisible */
        font-size: 0.9em;
    }
    
    .logic-subject {
        color: #38BDF8; /* Cyan */
        font-weight: bold;
        border-bottom: 2px solid #38BDF8;
    }

    .logic-verb {
        color: #FACC15; /* Yellow */
        font-weight: bold;
        margin: 0 5px;
    }

    .logic-arrow {
        display: inline-block;
        color: #FACC15;
        font-weight: bold;
        margin-right: 5px;
        animation: pulseArrow 1s infinite;
    }

    .logic-connector {
        background: #DC2626; /* Red Background */
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.8rem;
        margin-right: 5px;
        box-shadow: 0 0 10px #DC2626;
    }

    @keyframes pulseArrow {
        0% { transform: translateX(0); opacity: 0.5; }
        50% { transform: translateX(3px); opacity: 1; }
        100% { transform: translateX(0); opacity: 0.5; }
    }

    /* LOGIC DIAGRAM STYLES */
    .chain-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 20px;
        height: 100%;
        justify-content: center;
        animation: fadeIn 0.5s ease;
    }

    .chain-node {
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid #334155;
        color: #94a3b8;
        padding: 10px 15px;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        text-align: center;
        width: 80%;
        position: relative;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    /* Important Concepts (Blue) */
    .chain-node.core {
        border-color: #38BDF8;
        color: #38BDF8;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(56, 189, 248, 0.2);
    }

    /* The Final Conclusion (Red/Warning) */
    .chain-node.result {
        border-color: #F43F5E;
        color: #F43F5E;
        font-weight: bold;
        border-width: 2px;
    }

    /* The Arrow */
    .chain-arrow {
        color: #FACC15; /* Yellow */
        font-size: 1.2rem;
        font-weight: bold;
        text-shadow: 0 0 5px #FACC15;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ================= COLOR OVERRIDES ================= */

/* 1. THE READING PASSAGE TEXT */
/* Affects all types of text: Academic, News, Chat Logs, etc. */
.academic-text, 
.news-body, 
.log-body, 
.transcript-box, 
.passage {
    color: #F8FAFC !important; /* Bright White (Slate 50) */
    text-shadow: 0 0 1px rgba(0,0,0,0.5); /* Slight shadow for readability */
    font-weight: 400; /* Normal weight */
}

/* 2. THE QUESTION SENTENCE */
.q-text {
    color: #ffffff !important; /* Neon Cyan (Sky 400) */
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 15px;
    text-shadow: 0 0 10px rgba(56, 189, 248, 0.3); /* Soft Glow */
    line-height: 1.5;
}

/* 3. OPTIONAL: The "Question 1/20" Label */
.q-card div[style*="font-size:0.8rem"] {
    color: #FACC15 !important; /* Yellow/Gold */
    font-weight: 800;
    letter-spacing: 1px;
}
/* ================= THEME TITLE COLOR ================= */
.passage h3 {
    /* Change this HEX code to whatever color you want */
    color: #FACC15 !important; /* Current: Bright Gold */
    
    /* Optional: Make it glow */
    text-shadow: 0 0 10px rgba(250, 204, 21, 0.4); 
    
    /* Optional: Add a bottom border line */
    border-bottom: 2px solid #334155; 
    
    /* Layout spacing */
    padding-bottom: 10px;
    margin-top: 0;
    font-weight: 800; /* Extra Bold */
    letter-spacing: 1px;
}
/* ================= FIXED THEME TITLE COLOR ================= */
#textPanel h3 {
    /* Change this to a bright color (currently Gold) */
    color: #5ac2a9 !important; 
    font-family: 'Trebuchet MS', sans-serif;
    
    /* Optional: Add a text shadow to make it pop against dark blue */
    text-shadow: 0 0 10px rgba(0,0,0,0.8);

    /* Resetting margins to ensure it sits correctly */
    margin-top: 0;
    padding-bottom: 15px;
    border-bottom: 2px solid #334155;
}

    /* ================= SCROLLABLE QUIZ FIX ================= */

/* 1. Target the specific container holding the question card */
#quiz-container {
    height: 100%;       /* Fill the available grid space */
    overflow-y: auto;   /* Enable vertical scrolling */
    
    /* CRITICAL: Add padding at the bottom so Option E isn't cut off */
    padding-bottom: 60px !important; 
    
    /* Make scrollbar look nice */
    scrollbar-width: thin;
    scrollbar-color: var(--gold) #0F172A;
}

/* 2. Custom Scrollbar for Chrome/Edge */
#quiz-container::-webkit-scrollbar {
    width: 8px;
}
#quiz-container::-webkit-scrollbar-track {
    background: #0F172A;
}
#quiz-container::-webkit-scrollbar-thumb {
    background: #334155;
    border-radius: 4px;
}
#quiz-container::-webkit-scrollbar-thumb:hover {
    background: var(--gold);
}

/* 3. Mobile Specific Adjustment */
@media (max-width: 900px) {
    .control-panel {
        /* On mobile, the control panel holds the quiz */
        overflow-y: auto !important;
        padding-bottom: 80px !important; /* Extra space for touch scrolling */
    }
}
    /* ================= FIX FOR SHIP OF THESEUS TEXT ================= */
.news-wrapper, 
.news-body, 
.news-headline,
.news-meta {
    text-shadow: 0 0 1px rgba(0,0,0,0.8);
    background-color: #E2E8F0 !important;
    color: #0F172A !important; 
}
*/
    </style>
</head>
<body>

<div class="panic-overlay" id="panicOverlay"></div>
<div class="fx-overlay" id="damageOverlay"></div>
<div class="fx-overlay" id="healOverlay"></div>

<div class="screen-intro" id="introScreen">
    <div style="font-family: var(--font-tech); color: var(--gold); border: 1px solid var(--gold); padding: 5px 15px; border-radius: 4px; letter-spacing: 2px;">FINAL BOSS // 20 ROUNDS</div>
    <h1 class="intro-title">THE GAUNTLET</h1>
    <p style="color:#64748B; margin-top:10px;">4 Phases: Astro, Bio, Econ, AI</p>
    <button class="start-btn" onclick="startBattle()">START RAID</button>
</div>

<div class="screen-battle" id="battleScreen">
    
    <div class="hud-top">
        <div style="display:flex; flex-direction:column; flex:1; margin-right:20px;">
            
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div style="display:flex; gap:15px; align-items:center;">
                    <span style="font-family: var(--font-tech); font-size: 0.7rem; color: var(--gold);">BOSS INTEGRITY</span>
                    <span id="comboDisplay" style="font-family: var(--font-tech); font-size: 0.7rem; color: var(--green); opacity:0; transition:0.3s;">
                        CHAIN x1
                    </span>
                </div>
                <span style="font-family: var(--font-tech); font-size: 0.7rem; color: #818CF8;">
                    ABILITY CHARGE: <span id="manaText" style="font-weight:bold;">0%</span>
                </span>
            </div>

            <div style="display:flex; gap:10px; height:10px; width:100%;">
                
                <div class="boss-hp-container" style="flex:3; width:auto;">
                    <div class="boss-hp-bar" id="bossHP"></div>
                </div>

                <div style="flex:1; background:#1e293b; border-radius:5px; overflow:hidden; border:1px solid #334155; position:relative;">
                    <div id="bossManaBar" style="width:0%; height:100%; background:#818CF8; transition:width 0.2s; box-shadow:0 0 10px #818CF8;"></div>
                </div>
            
            </div>
        </div>

        <div class="timer" id="timer">20:00</div>
    </div>

    <div class="battle-arena">
        
        <div class="boss-sidebar" style="position:relative;"> <div id="bossBubble" class="boss-bubble">
            Jangan Mencontek!
        </div>
            <div class="boss-frame">
                <div class="boss-scaler">
                    <div id="bossEntity"></div>
                </div>
            </div>
            <div style="text-align:center; color:var(--text-muted); font-size:0.7rem; margin-top:10px; font-family:var(--font-tech);">
                PENGAWAS<br>AREA 04
            </div>
        </div>

        <div class="text-panel" id="textPanel">
            </div>

        <div class="control-panel">
            
            <div class="hero-interface" style="margin-bottom: 15px; padding: 10px; background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span style="font-family:var(--font-tech); font-size:0.7rem; color:#38BDF8;">NEURAL CHARGE</span>
                    <div class="focus-meter" style="display:flex; gap:5px;">
                        <div id="focus1" class="focus-pip"></div>
                        <div id="focus2" class="focus-pip"></div>
                        <div id="focus3" class="focus-pip"></div>
                        <div id="focus4" class="focus-pip"></div>
                        <div id="focus5" class="focus-pip"></div>
                    </div>
                </div>
                <div style="display:flex; gap:10px; height: 40px;">
                    <button id="skillBtn1" class="skill-btn disabled" onclick="castDoubleSlash()" title="Remove 2 Wrong Answers (Cost: 2)">
                        <span class="skill-icon">‚öîÔ∏è</span> <span class="skill-cost">II</span>
                    </button>
                    <button id="skillBtn2" class="skill-btn disabled" onclick="castKeywordExtractor()" title="FKeyword Extractor: Highlight Key Info (Cost: 3)">
                        <span class="skill-icon">üß¨</span> <span class="skill-cost">III</span>
                    </button>
                    <button id="skillBtn3" class="skill-btn disabled" onclick="castPrecisionStrike()" title="Precision Strike: Eliminate Wrong Anwers Manually (Cost: 4)">
                        <span class="skill-icon">üéØ</span> <span class="skill-cost">IV</span>
                    </button>
                </div>
            </div>

            <div id="quiz-container">
            </div>

            <div class="feedback-modal" id="fbModal"></div>
        </div>
    </div>

    <div class="hud-bottom">
        <button class="tool-btn" onclick="toggleTool(this, 'mode-suffix')"><span>‚úÇÔ∏è</span> SUFFIX CUTTER</button>
        <button class="tool-btn" onclick="toggleTool(this, 'mode-xray')"><span>üî¶</span> X-RAY SCANNER</button>
        <button class="tool-btn" onclick="toggleTool(this, 'mode-logic')"><span>üö¶</span> LOGIC VIEW</button>
    </div>

</div>

<div class="screen-win" id="winScreen">
    <h1 style="font-size:4rem; color:var(--gold); margin:0;">VICTORY</h1>
    <p style="color:#CBD5E1; font-size:1.5rem;">YOU SURVIVED 20 ROUNDS</p>
    <a href="index.html" class="start-btn" style="text-decoration:none; display:inline-block; margin-top:30px;">RETURN TO LOBBY</a>
</div>

<div class="screen-fail" id="failScreen">
    <h1 class="fail-title">MISSION FAILED</h1>
    <p class="fail-desc">
        Target remains active. Logic sync failed.<br>
        <span style="font-size:1rem; opacity:0.8;">You ran out of questions before defeating the boss.</span>
    </p>
    <button class="start-btn" style="background:var(--red); color:white; border:1px solid white;" onclick="location.reload()">RETRY SIMULATION</button>
</div>

<script>
    // =========================================================================
    // SECTION 1: GLOBAL VARIABLES & CONFIGURATION
    // =========================================================================
    
    // --- GAME ENGINE ---
    let currentQIndex = 0;
    let currentHP = 100;
    let timeLeft = 1200; 
    let timerInterval;
    let peekInterval; // For the "Cursed Word" peek mechanic

    // --- BOSS STATS ---
    let bossMana = 0;
    const MANA_PASSIVE_RATE = 0.1; // Fills 0.4% every 100ms
    const MANA_PENALTY = 25;       // +25% charge on wrong answer
    let bossSkillCycle = 0;
    let activeBossTimer = null;    // Tracks the 10s duration of boss skills
    let isAbilityActive = false;   // True when boss is currently attacking

    // --- HERO STATS (THE FIX) ---
    let playerFocus = 0;           // Current Blue Bars
    const MAX_FOCUS = 5;           // Max Blue Bars (Needed for Ultimate)
    
    let chargeProgress = 0;        // Internal counter (0, 1, 2)
    const CHARGE_REQ = 2;          // 3 Correct Answers = 1 Blue Bar
    
    let isSniperActive = false;    // Flag for Precision Strike Ability
    let baseDamage = 4; 
    let comboStreak = 0;

    // --- AUDIO CONTEXT ---
    const synth = window.speechSynthesis;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();


    // =========================================================================
    // SECTION 2: AUDIO ENGINE (MP3 BASED)
    // =========================================================================

    console.log(">> AUDIO ENGINE LOADING..."); 

    const soundMap = {
        // GENERAL
        'win': 'sfx_win.mp3',
        'lose': 'sfx_lose.mp3',
        'charge_complete': 'sfx_charge.mp3',

        // HERO TOOLS
        'tool_cut': 'sfx_tool_cut.mp3',
        'tool_scan': 'sfx_tool_scan.mp3',
        'tool_logic': 'sfx_tool_logic.mp3',

        // HERO ABILITIES
        'slash': 'sfx_ability_slash.mp3',
        'scan_activate': 'sfx_ability_chain.mp3',
        'sniper_load': 'sfx_ability_sniper.mp3',
        'gunshot': 'sfx_gunshot.mp3',

        // BOSS ABILITIES
        'boss_magic': 'sfx_boss_curse.mp3',
        'boss_lock': 'sfx_boss_lock.mp3',
        'boss_glitch': 'sfx_boss_glitch.mp3'
    };

    function playSound(key) {
        const filename = soundMap[key];
        
        if (!filename) {
            console.error(`>> AUDIO ERROR: Key '${key}' not found in soundMap.`);
            return;
        }

        const audio = new Audio(filename);
        audio.volume = 0.5; 
        
        const playPromise = audio.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.warn(`>> PLAY ERROR: Could not play '${filename}'.`);
            });
        }
    }

    // --- VISUAL FX ---
    function triggerVisualFX(type) {
        const overlay = document.getElementById(type === 'win' ? 'healOverlay' : 'damageOverlay');
        if(!overlay) return;
        const animClass = type === 'win' ? 'trigger-heal' : 'trigger-damage';
        overlay.classList.remove(animClass);
        void overlay.offsetWidth; 
        overlay.classList.add(animClass);
    }

    function spawnDamageNumber(amount) {
        const sidebar = document.querySelector('.boss-sidebar');
        if(!sidebar) return;
        const num = document.createElement('div');
        num.classList.add('damage-number');
        num.innerText = "-" + amount.toFixed(0);
        const randomX = Math.random() * 50 + 50; 
        const randomY = Math.random() * 50 + 100;
        num.style.left = randomX + "px";
        num.style.top = randomY + "px";
        sidebar.appendChild(num);
        setTimeout(() => num.remove(), 1000);
    }

    function showFeedback(isGood, msg) {
        const fb = document.getElementById('fbModal');
        fb.style.display = 'block';
        fb.style.borderColor = isGood ? 'var(--green)' : 'var(--red)';
        fb.style.color = isGood ? 'var(--green)' : 'var(--red)';
        fb.innerText = msg;
        setTimeout(() => fb.style.display = 'none', 2000);
    }
    
    // Fallbacks
    function playTone() {}
    function sfxSplat() {} 
    function sfxLock() {} 
    function sfxMagic() {}
    function sfxGlitch() {}


    // =========================================================================
    // SECTION 3: DATA STORE (C1 LEVEL - UTBK SIMULATION)
    // =========================================================================

    const passages = [
        { 
            id: 1, 
            title: "PHASE 1: ENVIRONMENTAL SCIENCE", 
            content: `<div class="academic-text"><p>Ocean acidification, often termed the "evil twin" of global warming, represents a <span class="core">formidable threat</span> to marine biodiversity. As the ocean absorbs approximately 30% of anthropogenic <span class="core">CO2 emissions</span>, a chemical reaction occurs that reduces seawater pH. This shift creates a <span class="junk">corrosive environment</span> for calcifying organisms such as corals, oysters, and some plankton.</p><p><span class="connector">Consequently</span>, these organisms struggle to build their calcium carbonate shells, leading to slower growth rates and increased mortality. <span class="connector">Furthermore</span>, the structural integrity of coral reefs is compromised. Since reefs provide <span class="core">critical habitats</span> for nearly a quarter of all marine species, their degradation could trigger a <span class="core">trophic cascade</span>, ultimately impacting global fisheries and food security.</p><p><span class="connector">Unless</span> carbon emissions are drastically curtailed, scientists predict that ocean pH could reach levels unseen for millions of years, potentially rendering the damage <span class="junk">irreversible</span>.</p></div>` 
        },
        { 
            id: 2, 
            title: "PHASE 2: SOCIOLOGICAL STUDY", 
            content: `<div class="transcript-box"><div class="speech-bubble host"><span class="speaker">NARRATOR</span>The "Gig Economy" is often marketed as the pinnacle of <span class="core">entrepreneurial freedom</span>. Be your own boss. Work when you want.</div><div class="speech-bubble guest"><span class="speaker">PROF. AL-SAYED</span>That is the <span class="junk">veneer</span>. The reality is quite different. These platforms utilize <span class="core">algorithmic management</span> to control behavior without human supervisors.</div><div class="speech-bubble host"><span class="speaker">NARRATOR</span>How so?</div><div class="speech-bubble guest"><span class="speaker">PROF. AL-SAYED</span>By using "nudges"‚Äîbonuses for working unsociable hours or penalties for declining too many tasks. <span class="connector">Thus</span>, the worker feels <span class="core">autonomous</span> but is strictly surveilled. <span class="connector">However</span>, unlike traditional employment, this system shifts all <span class="core">financial risk</span> onto the worker. If the car breaks down or demand drops, the algorithm offers no safety net. It creates a class of <span class="core">precarious labor</span>.</div></div>` 
        },
        { 
            id: 3, 
            title: "PHASE 3: PHILOSOPHICAL ESSAY", 
            content: `<div class="news-wrapper"><div class="news-header"><h1 class="news-headline">THE SHIP OF THESEUS</h1></div><div class="news-body"><p>The <span class="core">Ship of Theseus</span> is a thought experiment that challenges our understanding of <span class="core">identity</span> over time. Imagine a ship where, over the course of decades, every single wooden plank is replaced due to rot.</p><p><span class="connector">Ultimately</span>, a moment arrives when not one original component remains. Is it still the <span class="junk">same ship</span>? <span class="connector">Conversely</span>, if a collector gathered all the discarded rotten planks and reassembled them, which vessel holds the true identity of the Ship of Theseus?</p><p>This paradox applies to the human condition. Our cells regenerate; our memories fade and reconstruct. <span class="connector">Therefore</span>, if our physical substance is in constant flux, what <span class="core">constitutes</span> the "self"? Is it the material, or is it the <span class="core">continuity</span> of the pattern?</p></div></div>` 
        },
        { 
            id: 4, 
            title: "PHASE 4: TECH REPORT", 
            content: `<div class="log-wrapper"><div class="log-header">// ENCRYPTION STATUS: CRITICAL</div><div class="log-body"><div class="log-entry">Classical computers process data in <span class="core">bits</span> (0 or 1). <span class="connector">However</span>, quantum computers utilize <span class="core">qubits</span>, which can exist in a state of <span class="junk">superposition</span>. This allows them to perform complex calculations exponentially faster than binary systems.</div><br><div class="log-entry">IMPLICATION: The RSA encryption protocols that secure the global banking system rely on the difficulty of factoring large numbers. A sufficiently powerful quantum computer could break this <span class="junk">obsolete</span> encryption in minutes.</div><br><div class="log-entry"><span class="connector">Therefore</span>, the race for "Post-Quantum Cryptography" is not merely academic; it is a matter of <span class="core">national security</span>. We must transition to new standards before the "Q-Day" arrives.</div></div></div>` 
        }
    ];

    const questions = [
        // --- PASSAGE 1: ENVIRONMENT (Ocean Acidification) ---
        { 
            tId: 1, 
            q: "1. What is the primary purpose of the text?", 
            opts: [
                "A. To dispute the prevailing scientific consensus regarding global warming theories.", 
                "B. To provide a detailed chemical analysis of underwater photosynthesis.", 
                "C. To highlight the primary causes and severe consequences of ocean acidification.", 
                "D. To propose a new, cost-effective method for large-scale coral reef restoration.", 
                "E. To compare the varying biodiversity levels between the Atlantic and Pacific oceans."
            ], 
            ans: 2 
        }, // C
        { 
            tId: 1, 
            q: "2. According to the text, the term 'evil twin' refers to:", 
            opts: [
                "A. Ocean acidification, a parallel threat to global warming.", 
                "B. Global warming, which causes the ocean to heat up.", 
                "C. Carbon emissions that are released by factories.", 
                "D. Trophic cascades that destroy marine food webs.", 
                "E. Marine biodiversity loss due to overfishing."
            ], 
            ans: 0 
        }, // A
        { 
            tId: 1, 
            q: "3. The word 'compromised' in paragraph 2 is closest in meaning to:", 
            opts: [
                "A. Successfully negotiated via diplomacy.", 
                "B. Strengthened against external threats.", 
                "C. Balanced between two opposing forces.", 
                "D. Weakened and exposed to danger.", 
                "E. Mutually agreed upon by all parties."
            ], 
            ans: 3 
        }, // D
        { 
            tId: 1, 
            q: "4. What is the logical result of the 'trophic cascade' mentioned in the text?", 
            opts: [
                "A. A significant increase in carbon absorption by the ocean.", 
                "B. A widespread disruption in global food security and fisheries.", 
                "C. The rapid and uncontrolled growth of plankton populations.", 
                "D. A gradual decrease in the overall pH level of seawater.", 
                "E. The stabilization and recovery of coral reef ecosystems."
            ], 
            ans: 1 
        }, // B
        { 
            tId: 1, 
            q: "5. Which of the following best describes the function of the final paragraph?", 
            opts: [
                "A. It offers a scientific counter-argument to the previous claims.", 
                "B. It provides specific statistical data on fish mortality rates.", 
                "C. It defines the chemical composition of calcium carbonate.", 
                "D. It outlines the historical timeline of carbon emissions.", 
                "E. It issues a warning about the potential permanence of the damage."
            ], 
            ans: 4 
        }, // E

        // --- PASSAGE 2: SOCIOLOGY (Gig Economy) ---
        { 
            tId: 2, 
            q: "6. Prof. Al-Sayed's attitude toward the 'freedom' of the gig economy can best be described as:", 
            opts: [
                "A. Enthusiastic and supportive of the innovation.", 
                "B. Skeptical and critical of the underlying reality.", 
                "C. Indifferent and unconcerned with the outcome.", 
                "D. Confused by the technological complexity.", 
                "E. Optimistic about the future of labor rights."
            ], 
            ans: 1 
        }, // B
        { 
            tId: 2, 
            q: "7. The phrase 'precarious labor' implies that gig workers:", 
            opts: [
                "A. Earn significantly more than traditional employees.", 
                "B. Are protected by strong unions and labor laws.", 
                "C. Have full control over the algorithm's decisions.", 
                "D. Lack financial security and face instability.", 
                "E. Are frequently fired for working too hard."
            ], 
            ans: 3 
        }, // D
        { 
            tId: 2, 
            q: "8. What does the term 'veneer' suggest about the marketing of the gig economy?", 
            opts: [
                "A. It is a superficial appearance hiding a different reality.", 
                "B. It is a solid, trustworthy foundation for economic growth.", 
                "C. It is a legally binding contract between employer and employee.", 
                "D. It is a transparent and honest description of the job.", 
                "E. It is an outdated concept that no longer applies."
            ], 
            ans: 0 
        }, // A
        { 
            tId: 2, 
            q: "9. How does 'algorithmic management' differ from human supervision?", 
            opts: [
                "A. It is more lenient and forgiving of mistakes.", 
                "B. It creates a stronger sense of community among workers.", 
                "C. It offers better safety nets for emergencies.", 
                "D. It pays workers for downtime and breaks.", 
                "E. It uses digital 'nudges' rather than direct orders."
            ], 
            ans: 4 
        }, // E
        { 
            tId: 2, 
            q: "10. The professor mentions 'financial risk' to highlight that:", 
            opts: [
                "A. Algorithms are extremely expensive to build and maintain.", 
                "B. Workers must bear the cost of downtime and maintenance.", 
                "C. Companies are losing money on these platforms.", 
                "D. Customers are charged too much for the services.", 
                "E. Banks generally refuse to lend money to gig workers."
            ], 
            ans: 1 
        }, // B

        // --- PASSAGE 3: PHILOSOPHY (Identity) ---
        { 
            tId: 3, 
            q: "11. The central paradox of the 'Ship of Theseus' concerns:", 
            opts: [
                "A. The structural durability of wood versus metal parts.", 
                "B. The speed at which a ship can be constructed.", 
                "C. The persistence of identity amidst physical change.", 
                "D. The fluctuating economic value of antique ships.", 
                "E. The navigational skills required by Theseus."
            ], 
            ans: 2 
        }, // C
        { 
            tId: 3, 
            q: "12. In the analogy provided, the 'discarded rotten planks' represent:", 
            opts: [
                "A. The old physical components of an object.", 
                "B. Bad memories that should be entirely forgotten.", 
                "C. The future potential of the ship's voyage.", 
                "D. The logical errors in human reasoning.", 
                "E. The crew members who operate the ship."
            ], 
            ans: 0 
        }, // A
        { 
            tId: 3, 
            q: "13. The author implies that human identity is likely defined by:", 
            opts: [
                "A. The unique DNA found in our cells.", 
                "B. The physical matter that makes up our bodies.", 
                "C. The memories we successfully repress.", 
                "D. A simple, static concept that never changes.", 
                "E. The continuity of patterns rather than material substance."
            ], 
            ans: 4 
        }, // E
        { 
            tId: 3, 
            q: "14. The word 'constitutes' in the final paragraph could best be replaced by:", 
            opts: [
                "A. Destroys or eliminates.", 
                "B. Composes or forms.", 
                "C. Hides or obscures.", 
                "D. Questions or doubts.", 
                "E. Rejects or denies."
            ], 
            ans: 1 
        }, // B
        { 
            tId: 3, 
            q: "15. Why does the author transition from discussing a ship to discussing human cells?", 
            opts: [
                "A. To argue that ships are actually living organisms.", 
                "B. To confuse the reader with unrelated topics.", 
                "C. To demonstrate the philosophical concept's application to human existence.", 
                "D. To prove that biology is more important than carpentry.", 
                "E. To argue that humans live significantly longer than ships."
            ], 
            ans: 2 
        }, // C

        // --- PASSAGE 4: TECHNOLOGY (Quantum Computing) ---
        { 
            tId: 4, 
            q: "16. What is the fundamental difference between a bit and a qubit?", 
            opts: [
                "A. Bits process data faster than qubits.", 
                "B. Bits are used for encryption; qubits are not.", 
                "C. Bits represent text; qubits represent images.", 
                "D. Bits are physically smaller than qubits.", 
                "E. Bits are binary (0/1), while qubits can exist in superposition."
            ], 
            ans: 4 
        }, // E
        { 
            tId: 4, 
            q: "17. The text implies that the arrival of 'Q-Day' will cause:", 
            opts: [
                "A. A significant decrease in global internet speeds.", 
                "B. A worldwide shortage of personal computers.", 
                "C. A major security crisis for current banking systems.", 
                "D. The immediate end of all artificial intelligence.", 
                "E. A drastic reduction in global energy consumption."
            ], 
            ans: 2 
        }, // C
        { 
            tId: 4, 
            q: "18. The word 'obsolete' suggests that current RSA encryption will become:", 
            opts: [
                "A. Outdated and ineffective against new threats.", 
                "B. Significantly more expensive to maintain.", 
                "C. Legally required by all governments.", 
                "D. Faster to process but less secure.", 
                "E. Physically larger and harder to store."
            ], 
            ans: 0 
        }, // A
        { 
            tId: 4, 
            q: "19. The author's tone regarding Post-Quantum Cryptography is best described as:", 
            opts: [
                "A. Nostalgic for the past.", 
                "B. Lighthearted and humorous.", 
                "C. Indifferent and detached.", 
                "D. Urgent and serious.", 
                "E. Sarcastic and mocking."
            ], 
            ans: 3 
        }, // D
        { 
            tId: 4, 
            q: "20. Why is quantum computing considered a matter of 'national security'?", 
            opts: [
                "A. Because it consumes too much electricity grid power.", 
                "B. Because it could potentially decode sensitive state and financial data.", 
                "C. Because it requires rare materials found only in one country.", 
                "D. Because it will replace all human soldiers in the army.", 
                "E. Because it is currently illegal to own a quantum computer."
            ], 
            ans: 1 
        } // B
    ];


    // =========================================================================
    // SECTION 4: MAIN GAME ENGINE (Start/Load/Check)
    // =========================================================================

    function startBattle() {
        document.getElementById('introScreen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('battleScreen').style.display = 'grid';
            document.getElementById('battleScreen').style.opacity = '1';
            loadQuestion(0);
            startTimer();
            // Start the passive mana generation loop
            startBossLoop();
        }, 500);
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            // Respect Time Freeze Ability
            if (!window.isTimeFrozen) {
                timeLeft--;
            }
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById('timer').innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
            if(timeLeft <= 0) { clearInterval(timerInterval); alert("MISSION FAILED"); }
        }, 1000);
    }

    function loadQuestion(idx) {
        resetBoardState(); // CLEANUP BEFORE LOADING NEW QUESTION
        
        // CHECK END CONDITIONS
        if(idx >= questions.length) { 
            if(currentHP > 0) failGame(); else winGame(); 
            return; 
        }
        
        const qData = questions[idx];
        const currentPassage = passages.find(p => p.id === qData.tId);
        const textPanel = document.getElementById('textPanel');
        
        // Load Text (Only if different from current)
        if (!textPanel.innerHTML.includes(currentPassage.title)) {
            textPanel.style.opacity = '0';
            setTimeout(() => {
                textPanel.innerHTML = `<h3>${currentPassage.title}</h3>${currentPassage.content}`;
                textPanel.style.opacity = '1';
                // Re-apply tool modes if active
                document.querySelectorAll('.tool-active').forEach(btn => {
                    if(btn.innerText.includes("SUFFIX")) textPanel.classList.add('mode-suffix');
                    if(btn.innerText.includes("X-RAY")) textPanel.classList.add('mode-xray');
                    if(btn.innerText.includes("LOGIC")) textPanel.classList.add('mode-logic');
                });
            }, 300);
        }

        const qContainer = document.getElementById('quiz-container');
        let optsHTML = "";
        qData.opts.forEach((opt, i) => {
            optsHTML += `<button class="opt-btn" onclick="checkAnswer(this, ${i === qData.ans})">${opt}</button>`;
        });

        qContainer.innerHTML = `
            <div class="q-card">
                <div style="font-size:0.8rem; color:var(--gold); margin-bottom:10px;">QUESTION ${idx + 1} / 20</div>
                <div class="q-text">${qData.q}</div>
                ${optsHTML}
            </div>
        `;
    }

    function checkAnswer(btn, isCorrect) {
        // ============================================
        // 1. SNIPER MODE (PRECISION STRIKE) LOGIC
        // ============================================
        if(isSniperActive) {
            if(!isCorrect) {
                // HIT WRONG TARGET -> DESTROY IT
                btn.style.transition = "0.2s";
                btn.style.transform = "scale(0.9)";
                btn.style.backgroundColor = "#EF4444";
                setTimeout(() => {
                    btn.style.visibility = "hidden";
                    btn.style.pointerEvents = "none";
                }, 200);
                try { playSound('gunshot'); } catch(e){}
                return; // STOP HERE (Don't run normal loss logic)
            } else {
                // HIT CORRECT TARGET -> WIN & EXIT SNIPER MODE
                isSniperActive = false;
                document.body.classList.remove('sniper-active');
                // Allow code to continue down to Normal Win Logic...
            }
        }

        // ============================================
        // 2. NORMAL GAMEPLAY LOGIC
        // ============================================
        const allBtns = document.querySelectorAll('.opt-btn');
        allBtns.forEach(b => b.style.pointerEvents = 'none');
        
        const bossEntity = document.getElementById('bossEntity');
        const comboDisplay = document.getElementById('comboDisplay');

        if(isCorrect) {
            // --- WIN LOGIC ---
            comboStreak++; 
            
            // HERO: CHARGE ENERGY BAR
            processNeuralCharge(); 
            
            let totalDmg = baseDamage + (comboStreak * 1.5);
            currentHP -= totalDmg;
            document.getElementById('bossHP').style.width = Math.max(0, currentHP) + "%";
            
            btn.classList.add('opt-correct');
            if(comboDisplay) {
                comboDisplay.innerText = `CHAIN x${comboStreak}`;
                comboDisplay.classList.add('combo-active');
            }

            spawnDamageNumber(totalDmg);
            triggerVisualFX('win');
            try { playSound('win'); } catch(e){}

            // Boss Visual Reaction
            if (currentHP < 30) bossEntity.classList.add('boss-critical');
            else {
                 bossEntity.classList.add('state-damaged');
                 setTimeout(() => bossEntity.classList.remove('state-damaged'), 1000);
            }

            if(currentHP <= 0) setTimeout(winGame, 1000);
            else setTimeout(() => { currentQIndex++; loadQuestion(currentQIndex); }, 1500);

        } else {
            // --- LOSS LOGIC ---
            comboStreak = 0;
            btn.classList.add('opt-wrong');
            allBtns.forEach(b => { 
                if(b.getAttribute('onclick').includes('true')) b.classList.add('opt-correct'); 
            });
            
            // Move next after delay
            setTimeout(() => { currentQIndex++; loadQuestion(currentQIndex); }, 2500);

            // Penalties
            if(comboDisplay) {
                comboDisplay.innerText = "CHAIN BROKEN";
                comboDisplay.classList.remove('combo-active');
            }
            addMana(25); // Boss charges up
            showFeedback(false, "WRONG! CHARGE +25%");
            
            bossSpeak("attack");
            bossEntity.classList.add('state-attack');
            setTimeout(() => { bossEntity.classList.remove('state-attack'); }, 1500);
            
            triggerVisualFX('lose');
            try { playSound('lose'); } catch(e){}
            document.body.classList.add('shake-screen');
            setTimeout(() => document.body.classList.remove('shake-screen'), 500);
        }
    }


    // =========================================================================
    // SECTION 5: HERO SYSTEM (ENERGY & SKILLS) - UPDATED
    // =========================================================================

    function processNeuralCharge() {
        // 1. Increment Internal Counter
        chargeProgress++;
        console.log(`>> CHARGE STATUS: ${chargeProgress} / ${CHARGE_REQ}`);

        // 2. Check if we reached the threshold (3 correct answers)
        if(chargeProgress >= CHARGE_REQ) {
            // SUCCESS! Give 1 Bar
            chargeProgress = 0; 
            addFocus(1); 
            showFeedback(true, "ENERGY CELL CHARGED! (+1)");
            try { playSound('charge_complete'); } catch(e){}
        } else {
            // PARTIAL CHARGE (Show percentage)
            const percent = Math.floor((chargeProgress / CHARGE_REQ) * 100);
            showFeedback(true, `CHARGING... ${percent}%`);
        }
    }

    function addFocus(amount) {
        playerFocus += amount;
        if(playerFocus > MAX_FOCUS) playerFocus = MAX_FOCUS;
        if(playerFocus < 0) playerFocus = 0;
        updateFocusUI();
    }

    function updateFocusUI() {
        // 1. Update Blue Pips
        for(let i=1; i<=MAX_FOCUS; i++) {
            const pip = document.getElementById(`focus${i}`);
            if(pip) {
                if(i <= playerFocus) pip.classList.add('active');
                else pip.classList.remove('active');
            }
        }
        
        // 2. Unlock Buttons based on Cost (Tier 1=2, Tier 2=3, Tier 3=5)
        const btn1 = document.getElementById('skillBtn1');
        const btn2 = document.getElementById('skillBtn2');
        const btn3 = document.getElementById('skillBtn3');

        if(btn1 && btn2 && btn3) {
            [btn1, btn2, btn3].forEach(b => {
                 b.classList.remove('ready', 'disabled');
                 b.classList.add('disabled');
            });

            if(playerFocus >= 2) { btn1.classList.remove('disabled'); btn1.classList.add('ready'); }
            if(playerFocus >= 3) { btn2.classList.remove('disabled'); btn2.classList.add('ready'); }
            if(playerFocus >= 4) { btn3.classList.remove('disabled'); btn3.classList.add('ready'); }
        }
    }

    // --- SKILL 1: DOUBLE SLASH (Cost: 2) ---
    function castDoubleSlash() {
        if(playerFocus < 2) return;
        if(isAbilityActive) return; 

        addFocus(-2);
        try { playSound('slash'); } catch(e){}

        const allBtns = Array.from(document.querySelectorAll('.opt-btn'));
        const correctBtn = allBtns.find(b => b.getAttribute('onclick').includes('true'));
        const wrongBtns = allBtns.filter(b => b !== correctBtn && b.style.visibility !== 'hidden');

        // Randomly hide 2
        wrongBtns.sort(() => Math.random() - 0.5);
        let count = 0;
        wrongBtns.forEach(btn => {
            if(count < 2) {
                btn.style.transition = "0.2s";
                btn.style.transform = "scaleX(0)";
                setTimeout(() => btn.style.visibility = "hidden", 200);
                count++;
            }
        });
    }

    
    // --- SKILL 2: LOGIC VISUALIZER (Cost: 3) ---
    function castKeywordExtractor() {
        if(playerFocus < 3) return;

        // 1. DEFINE LOGIC MAPS FOR THE NEW TEXTS
        const logicSummaries = {
            1: [ // Phase 1: Ocean Acidification
                { type: "core", text: "CO2 Emissions" },
                { type: "arrow", text: "ABSORBED BY" },
                { type: "node", text: "Oceans (Lowers pH)" },
                { type: "arrow", text: "CAUSES" },
                { type: "core", text: "Calcification Decline" },
                { type: "arrow", text: "RESULT" },
                { type: "result", text: "ECOSYSTEM COLLAPSE" }
            ],
            2: [ // Phase 2: The Gig Economy
                { type: "node", text: "Promise of Freedom" },
                { type: "arrow", text: "VS" },
                { type: "core", text: "Algorithmic Control" },
                { type: "arrow", text: "MECHANISM" },
                { type: "node", text: "Surveillance & Nudges" },
                { type: "arrow", text: "REALITY" },
                { type: "result", text: "PRECARIOUS LABOR" }
            ],
            3: [ // Phase 3: Ship of Theseus
                { type: "node", text: "Object X (Original)" },
                { type: "arrow", text: "PROCESS" },
                { type: "core", text: "Gradual Replacement" },
                { type: "arrow", text: "LEADS TO" },
                { type: "node", text: "Object Y (New Parts)" },
                { type: "arrow", text: "PARADOX" },
                { type: "result", text: "IS X EQUAL TO Y?" }
            ],
            4: [ // Phase 4: Quantum Computing
                { type: "core", text: "Classical Bits (0 or 1)" },
                { type: "arrow", text: "REPLACED BY" },
                { type: "core", text: "Qubits (Superposition)" },
                { type: "arrow", text: "IMPLICATION" },
                { type: "node", text: "Breaks RSA Encryption" },
                { type: "arrow", text: "URGENCY" },
                { type: "result", text: "POST-QUANTUM SECURITY" }
            ]
        };

        // 2. CALCULATE PHASE & EXECUTE
        let currentPhase = 1;
        if(currentQIndex >= 5) currentPhase = 2;
        if(currentQIndex >= 10) currentPhase = 3;
        if(currentQIndex >= 15) currentPhase = 4;

        const chainData = logicSummaries[currentPhase];

        addFocus(-3);
        try { playSound('scan_activate'); } catch(e) {}

        const panel = document.getElementById('textPanel');
        let html = '<div class="chain-container">';
        
        if(chainData) {
            chainData.forEach(item => {
                if(item.type === 'arrow') {
                    html += `<div class="chain-arrow">‚Üì ${item.text} ‚Üì</div>`;
                } else {
                    html += `<div class="chain-node ${item.type}">${item.text}</div>`;
                }
            });
        }
        
        html += '</div>';
        panel.innerHTML = html;
        showFeedback(true, "LOGIC EXTRACTED");
    }

    // --- SKILL 3: PRECISION STRIKE (Cost: 5) ---
    function castPrecisionStrike() {
        if(playerFocus < 4) return; 

        addFocus(-4);
        try { playSound('sniper_load'); } catch(e){}

        isSniperActive = true;
        document.body.classList.add('sniper-active'); 
        showFeedback(true, "PRECISION STRIKE ACTIVE: ELIMINATE TARGETS");
    }


    // =========================================================================
    // SECTION 6: BOSS AI & MECHANICS
    // =========================================================================

    function startBossLoop() {
        setInterval(() => {
            const failScreen = document.getElementById('failScreen');
            const isFailVisible = window.getComputedStyle(failScreen).display === 'flex'; 
            const isPeeking = document.getElementById('panicOverlay') && document.getElementById('panicOverlay').classList.contains('panic-active');

            if (currentHP > 0 && !isFailVisible && !isPeeking && !isAbilityActive) {
                addMana(MANA_PASSIVE_RATE);
            }
        }, 100); 
    }

    function addMana(amount) {
        if(currentHP <= 0) return;
        if(isAbilityActive) return; 

        bossMana += amount;
        if(bossMana > 100) bossMana = 100;
        
        const bar = document.getElementById('bossManaBar');
        const text = document.getElementById('manaText');
        if(bar) bar.style.width = bossMana + "%";
        if(text) text.innerText = Math.floor(bossMana) + "%";

        if(bossMana >= 100) {
            console.log(">> BOSS CHARGE FULL! Initiating Attack...");
            isAbilityActive = true; 
            bossMana = 0;
            if(bar) bar.style.width = "0%";
            if(text) text.innerText = "0%";

            try { triggerBossSkill(); } catch(e) {
                console.error(e);
                finishBossAttack(); 
            }
        }
    }

    const bossLines = {
        idle: ["Waktu berjalan...", "Kerjakan sendiri.", "Mata ke monitor.", "Jangan berisik."],
        hit: ["Mustahil!", "Kok bisa tahu?!", "Hoki doang itu!", "Siapa gurumu?!", "Tunggu soal berikutnya!"],
        attack: ["SALAH!", "Minus poin!", "Kamu tidak belajar?!", "Saya catat nomor kamu!", "Gagal total!"]
    };

    function bossSpeak(type) {
        const bubble = document.getElementById('bossBubble');
        if(!bubble) return;
        const lines = bossLines[type] || bossLines['idle'];
        const randomLine = lines[Math.floor(Math.random() * lines.length)];
        
        bubble.innerText = randomLine;
        bubble.classList.add('bubble-show');
        setTimeout(() => { bubble.classList.remove('bubble-show'); }, 2000);
    }
    
    function bossSpeakAttack(text) {
        const bubble = document.getElementById('bossBubble');
        bubble.innerText = text;
        bubble.style.color = "var(--red)";
        bubble.classList.add('bubble-show');
        setTimeout(() => {
            bubble.classList.remove('bubble-show');
            bubble.style.color = "black";
        }, 2000);
        
        const boss = document.getElementById('bossEntity');
        boss.classList.add('state-attack');
        setTimeout(() => boss.classList.remove('state-attack'), 1000);
    }

    function triggerBossSkill() {
        if (currentHP <= 0 || document.getElementById('failScreen').style.display === 'flex') {
            isAbilityActive = false; return;
        }

        let skillName = "";
        if (bossSkillCycle === 0) { skillName = "VOCABULARY CHECK"; skillLexicalOverload(); } 
        else if (bossSkillCycle === 1) { skillName = "SILENCE (LOCK)"; skillSilence(); } 
        else if (bossSkillCycle === 2) { skillName = "SYSTEM GLITCH"; skillGlitch(); }

        showSkillAnnouncement(skillName);

        bossSkillCycle++; 
        if (bossSkillCycle > 2) bossSkillCycle = 0;

        // Watchdog
        setTimeout(() => {
            if(isAbilityActive) {
                console.warn(">> WATCHDOG: Force-unlocking mana bar.");
                isAbilityActive = false;
            }
        }, 12000); 
    }

    function showSkillAnnouncement(name) {
        let announce = document.getElementById('skillAnnounce');
        if (!announce) {
            announce = document.createElement('div');
            announce.id = 'skillAnnounce';
            announce.style.cssText = 'position:fixed; top:20%; left:50%; transform:translate(-50%, -50%); background:rgba(255,0,0,0.8); color:white; padding:10px 30px; font-family:monospace; font-weight:bold; z-index:1000; pointer-events:none; border:2px solid white; display:none;';
            document.body.appendChild(announce);
        }
        announce.innerText = "BOSS CASTING: " + name;
        announce.style.display = 'block';
        setTimeout(() => { announce.style.display = 'none'; }, 2000);
    }

    // --- BOSS ABILITY 1: VOCABULARY OVERLOAD ---
    function skillLexicalOverload() {
        console.log(">> SKILL: Lexical Overload");
        bossSpeakAttack("VOCABULARY CHECK!");
        
        // TRIGGER NEW SOUND
        playSound('boss_magic'); 

        const localMatrix = {
            "common": ["ubiquitous", "prevalent"], "rare": ["scarce", "infrequent"],
            "life": ["existence", "sentience"], "humans": ["homo sapiens", "populace"],
            "exist": ["persist", "endure"], "filter": ["sift", "winnow"],
            "idea": ["concept", "paradigm"], "view": ["perspective", "standpoint"],
            "change": ["fluctuate", "metamorphose"], "evidence": ["corroboration", "substantiation"],
            "difficult": ["arduous", "laborious"], "likely": ["plausible", "presumable"],
            "is": ["constitutes", "represents"], "are": ["embody", "constitute"],
            "many": ["multitudinous", "myriad"]
        };

        const panel = document.getElementById('textPanel');
        const walker = document.createTreeWalker(panel, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const targetableNodes = [];

        while(node = walker.nextNode()) {
            const text = node.nodeValue;
            if(text.trim().length > 2) {
                 const hasKeyword = Object.keys(localMatrix).some(key => new RegExp(`\\b${key}\\b`, 'i').test(text));
                const parentClass = node.parentNode.className || "";
                if(hasKeyword && !parentClass.includes("cursed-word")) targetableNodes.push(node);
            }
        }

        if(targetableNodes.length === 0) { finishBossAttack(); return; }

        const attackCount = Math.min(5, targetableNodes.length);
        for(let i=0; i<attackCount; i++) {
            const targetNode = targetableNodes[Math.floor(Math.random() * targetableNodes.length)];
            const text = targetNode.nodeValue;
            const foundKey = Object.keys(localMatrix).find(key => new RegExp(`\\b${key}\\b`, 'i').test(text));

            if(foundKey) {
                const replacements = localMatrix[foundKey];
                const advancedWord = replacements[Math.floor(Math.random() * replacements.length)];
                const match = text.match(new RegExp(`\\b${foundKey}\\b`, 'i'));
                if(!match) continue;
                const originalWordExact = match[0];

                const span = document.createElement('span');
                span.className = "cursed-word";
                span.innerText = advancedWord.toUpperCase();
                span.dataset.original = originalWordExact;
                span.dataset.cursed = advancedWord.toUpperCase();
                span.dataset.state = "closed"; 
                span.setAttribute("onclick", "togglePeek(this)"); 
                span.style.userSelect = "none"; 
                span.style.cursor = "pointer";

                const wrapper = document.createElement('span');
                const safeKey = foundKey.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const parts = text.split(new RegExp(`\\b${safeKey}\\b`, 'i'));

                if(parts.length > 1) {
                    wrapper.innerHTML = parts[0];
                    wrapper.appendChild(span);
                    wrapper.append(parts.slice(1).join(originalWordExact));
                    targetNode.parentNode.replaceChild(wrapper, targetNode);
                }
            }
        }
        activeBossTimer = setTimeout(finishBossAttack, 10000); 
    }

    // --- BOSS ABILITY 2: SILENCE ---
    function skillSilence() {
        // TRIGGER NEW SOUND
        playSound('boss_lock'); 

        bossSpeakAttack("DIAM!");
        const btns = document.querySelectorAll('.opt-btn');
        if(btns.length > 0) {
            btns.forEach(btn => {
                btn.classList.add('opt-locked');
                btn.style.pointerEvents = 'none';
            });
            activeBossTimer = setTimeout(finishBossAttack, 10000); 
        } else {
            finishBossAttack();
        }
    }

    // --- BOSS ABILITY 3: GLITCH ---
    function skillGlitch() {
        // TRIGGER NEW SOUND
        playSound('boss_glitch'); 

        bossSpeakAttack("SYSTEM ERROR...");
        const qText = document.querySelector('.q-text');
        if(!qText) { finishBossAttack(); return; }

        const originalText = qText.innerText;
        qText.classList.add('text-glitched');
        qText.innerText = originalText.split('').sort(() => 0.5 - Math.random()).join('');

        activeBossTimer = setTimeout(() => {
            qText.innerText = originalText; 
            finishBossAttack();
        }, 5000);
    }


    // =========================================================================
    // SECTION 7: STATE MANAGEMENT & CLEANUP
    // =========================================================================

    function finishBossAttack() {
        console.log(">> ATTACK ENDED: Resuming Mana Generation & Cleaning Up");
        isAbilityActive = false;
        
        // Clean Words
        const cursed = document.querySelectorAll('.cursed-word');
        cursed.forEach(span => {
            if(span.dataset.original) {
                if(span.dataset.state === "open" && window.togglePeek) window.togglePeek(span); 
                const text = document.createTextNode(span.dataset.original);
                span.parentNode.replaceChild(text, span);
            }
        });

        // Clean Buttons
        const btns = document.querySelectorAll('.opt-btn');
        btns.forEach(btn => {
            btn.classList.remove('opt-locked');
            btn.style.pointerEvents = 'auto';
        });

        // Clean Glitch
        const qText = document.querySelector('.q-text');
        if(qText) qText.classList.remove('text-glitched');

        try { playTone(600, 'sine', 0.5, 0.1); } catch(e){}
    }

    function resetBoardState() {
        console.log(">> SYSTEM: Cleaning Board.");
        isAbilityActive = false;
        
        // 1. DISABLE SNIPER MODE
        isSniperActive = false;
        document.body.classList.remove('sniper-active');
        
        // 2. DISABLE LOGIC VISUALIZER (The new update)
        const panel = document.getElementById('textPanel');
        if(panel) panel.classList.remove('logic-mode');

        // 3. KILL BOSS TIMERS
        if (activeBossTimer) { clearTimeout(activeBossTimer); activeBossTimer = null; }

        // 4. RESET BUTTONS
        const btns = document.querySelectorAll('.opt-btn');
        btns.forEach(btn => {
            btn.classList.remove('opt-locked');
            btn.style.pointerEvents = 'auto';
            btn.style.visibility = 'visible';
            btn.style.transform = 'none';
        });

        // 5. RESET GLITCH & CURSES
        const qText = document.querySelector('.q-text');
        if(qText) qText.classList.remove('text-glitched');

        const cursed = document.querySelectorAll('.cursed-word');
        cursed.forEach(span => {
            if(span.dataset.original) {
                const text = document.createTextNode(span.dataset.original);
                span.parentNode.replaceChild(text, span);
            }
        });

        // 6. RESET VISUAL OVERLAYS
        const panic = document.getElementById('panicOverlay');
        if(panic) panic.classList.remove('panic-active');
        document.body.classList.remove('shake-screen');
        if(typeof peekInterval !== 'undefined') clearInterval(peekInterval);
        
        const timerEl = document.getElementById('timer');
        if(timerEl) timerEl.style.color = "#EF4444";
    }
    
    // Toggle for the Cursed Words (Global)
    window.togglePeek = function(span) {
        if (span.dataset.state === "closed") {
            span.dataset.state = "open";
            span.innerText = span.dataset.original; 
            span.style.color = "#FFFFFF"; 
            span.style.backgroundColor = "#DC2626";
            span.style.padding = "0 4px";
            span.style.borderRadius = "4px";
            const panic = document.getElementById('panicOverlay');
            if(panic) panic.classList.add('panic-active');
            
            if(peekInterval) clearInterval(peekInterval);
            peekInterval = setInterval(() => {
                if(typeof timeLeft !== 'undefined') {
                    timeLeft--; 
                    try { playTone(800, 'square', 0.05, 0.05); } catch(e){}
                    let m = Math.floor(timeLeft / 60);
                    let s = timeLeft % 60;
                    document.getElementById('timer').innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
                    if(timeLeft <= 0) { clearInterval(peekInterval); failGame(); }
                }
            }, 200); 
        } else {
            span.dataset.state = "closed";
            span.innerText = span.dataset.cursed; 
            span.style.color = "#C084FC"; 
            span.style.backgroundColor = "transparent";
            span.style.padding = "0";
            const panic = document.getElementById('panicOverlay');
            if(panic) panic.classList.remove('panic-active');
            if(peekInterval) clearInterval(peekInterval);
        }
    }

    function toggleTool(btn, modeClass) {
        // 1. Play Sound based on the tool
        if (modeClass === 'mode-suffix') playSound('tool_cut');
        if (modeClass === 'mode-xray') playSound('tool_scan');
        if (modeClass === 'mode-logic') playSound('tool_logic');

        // 2. Visual Toggle
        btn.classList.toggle('tool-active');
        document.getElementById('textPanel').classList.toggle(modeClass);
    }

    function winGame() {
        clearInterval(timerInterval);
        try{ confetti({ particleCount: 300, spread: 120 }); } catch(e){}
        document.getElementById('winScreen').style.display = 'flex';
        playSound('win');
    }

    function failGame() {
        clearInterval(timerInterval);
        document.getElementById('failScreen').style.display = 'flex';
        playSound('lose');
    }

</script>

</body>
</html>